---
title: "ONS76-CBO_Seurat_EXPLORE1_50K"
author: "JJ"
date: "11/08/2022"
output: html_document
---

```{r graphical_output}
options(bitmapType='cairo-png') # this line of code needed BEFORE knitr code in chunk below
```

```{r setup, include=FALSE}
knitr::opts_chunk$set(dev = "png",
                      dpi = 300,
                      echo = TRUE,   # prints the code (if FALSE then only code output is shown)
                      cache = TRUE,
                      fig.path = "./outputs50K/ONS76-CBO/figures/")
```

```{r libraries}
# library(reshape2) for formatting long table
suppressPackageStartupMessages({
library(Seurat)
library(glmGamPoi)
library(RColorBrewer)
library(fgsea)
library(msigdbr)
library(presto)
library(Matrix)
library(heatmap3)
library(patchwork)
library(tidyverse)
library(plyr)
})
```

```
{r}
# FOR KNIT DO NOT RE-RUN THIS CODE CHUNK
load("RDataFiles/ONS76-CBO_Seurat_EXPLORE1_50K.RData")
```


------------------------------------------------------------------------------------------
***Load the clusterMap object of ONS76-CBO sample and the annotated sample***
Although this file/object was part of the clusterMap workflow (Feb 2023) a clustered object that has undergone mitochondrial, ribosomal, cell and gene filtering, cell cycle difference regressed has been saved. Normalisation method = SCTransform. This file avoids the error of a normalisation step before SCT which was performed inappropriately for all samples in the QC files.

```{r}
o76cbo <- 
  readRDS("outputs50K/ONS76-CBO/ClusterMapInput.ONS76cbo.NoRiboNoMito.SCT.clustered.CCdiffRegressed.rds")
```

```{r DimplotONS76cboSCTphaseCCdiffRegressed, fig.height=6, fig.width=10}
DimPlot(o76cbo, label = TRUE) # '+ NoLegend()' is an option to insert here
```


```{r ElbowPlotONS76cboPhaseSCTclust}
# elbow plot shows that there is an elbow at PC ~10.
# The input object is the CLUSTERED saved seurat object

ElbowPlot(o76cbo, ndims = 50, reduction = "pca")
```

There are 2545 cells and the breakdown by cluster is shown
```{r}
# cluster 10, 11, 12 have < 100 cells each.
# ONS76 clusters = 5 (215 cells), 9 (116 cells), 10 (74 cells), 11 (60 cells)
cell.num <- table(o76cbo@active.ident)
cell.num
sum(cell.num)
```

```{r}
o76cbo.POSmarkers <- read.csv("outputs50K/ONS76-CBO/ClusterMapInput.FindAllMarkers.ONS76-CBO.csv",
                           header = TRUE,
                           stringsAsFactors = FALSE)
```


```{r}
dim(o76cbo.POSmarkers)
```

Check out the first few DEGs by group (cluster_ID) of 'markers.pos'
```{r}
# In clusterMap, cluster 1 in ONS76-CBO has no counterpart in CBO. However, manual inspection by comparing
# markers of cluster 1 in ONS76-CBO and cluster 1 in CBO suggest these cluster 1 ONS76-CBO cells 
# are in fact most similar to CBO 'RP-choroid plexus_1'

o76cbo.POSmarkers %>% 
  dplyr::filter(gene %in% c("NACA", "FOXO1", "ATP5F1E", "S100A11"))
```

```{r}
# load the cbo markers to compare with the above
cbo.markers <- read.csv("outputs50K/CBO/ClusterMapInput.FindAllMarkers.CBO.csv",
                        header = TRUE,
                        stringsAsFactors = FALSE)
```

```{r}
cbo.markers %>% 
  filter(cluster == "8") %>% 
  head()
```


***CLUSTER ANNOTATION*** 
```{r}
# continue to replace the cluster numbers with the identity of each cluster
new.cluster.ids <- c("roof plate", "Purkinje_1-3", "granule neurons", 
                     "ONS76_cluster_3", "4th vent/choroid plexus", "GABA-ergic neurons", "uncertain",
                     "oligodendrocytes", "ONS76_cluster_8", "uncertain", "RL/roof plate")

names(new.cluster.ids) <- levels(o76cbo)
o76cbo.annotate <- RenameIdents(o76cbo, new.cluster.ids)
```


```{r}
# Create metadata dataframe
metadata <- o76cbo.annotate@meta.data
# Add cell IDs to metadata
metadata$cells <- rownames(metadata)
# Create sample column
metadata$celltype <- NA
metadata$celltype[which(metadata$seurat_clusters == "0")] <- "roof plate"
metadata$celltype[which(metadata$seurat_clusters == "1")] <- "Purkinje_1-3"
metadata$celltype[which(metadata$seurat_clusters == "2")] <- "granule neurons"
metadata$celltype[which(metadata$seurat_clusters == "3")] <- "ONS76_cluster_3"
metadata$celltype[which(metadata$seurat_clusters == "4")] <- "4th vent/choroid plexus"
metadata$celltype[which(metadata$seurat_clusters == "5")] <- "GABA-ergic neurons"
metadata$celltype[which(metadata$seurat_clusters == "6")] <- "uncertain"
metadata$celltype[which(metadata$seurat_clusters == "7")] <- "oligodendrocytes"
metadata$celltype[which(metadata$seurat_clusters == "8")] <- "ONS76_cluster_8"
metadata$celltype[which(metadata$seurat_clusters == "9")] <- "uncertain"
metadata$celltype[which(metadata$seurat_clusters == "10")] <- "RL/roof plate"
```

```{r}
o76cbo.annotate@meta.data <- metadata
```

```{r}
head(o76cbo.annotate@meta.data)
```


```{r}
saveRDS(o76cbo.annotate, 
  file = "./outputs50K/ONS76-CBO/ons76cbo.CellAnnot.filtRiboMito.SCT.CCdiffRegressed.clustered.clusterMap.rds")
```


```{r}
# load the 'cbo.annotate' object
cbo.annotate <- 
  readRDS("outputs50K/CBO/cbo.filtRiboMito.CellAnnot.SCT.CCdiffRegressed.clustered.clusterMap.rds")
```


```{r}
# load the stored annotated ons76-cbo seurat object
o76cbo.annotate <- readRDS("outputs50K/ONS76-CBO/ons76cbo.CellAnnot.filtRiboMito.SCT.CCdiffRegressed.clustered.clusterMap.rds")
```

```{r DimplotONS76cboAnnotated, fig.height=6, fig.width=10}
DimPlot(o76cbo.annotate, label = TRUE, repel = TRUE)
```


--------------------------------------------------------------------------------------------------------
***Correlation heatmap of ONS76-CBO vs CBO - Spearman correlation***
code from: https://github.com/quadbiolab/scRNAseq_analysis_vignette/blob/master/Tutorial.md
using Spearman correlation
KNITTING THESE CODE CHUNKS FAILS!!

```{r}
av.exp.cbo <- sapply(sort(unique(cbo.annotate$celltype)), function(ct) rowMeans(cbo.annotate$RNA@data[,which(cbo.annotate$celltype == ct)] ))
```

```{r}
avg.exp.ons76Cbo <- sapply(levels(o76cbo.annotate@active.ident), function(ct) rowMeans(o76cbo.annotate$RNA@data[,which(o76cbo.annotate@active.ident == ct)]))
```

```{r}
genes2cor <- intersect(VariableFeatures(cbo.annotate), 
                       rownames(o76cbo.annotate))
corr2ons76.cbo.cl <- cor(avg.exp.ons76Cbo[genes2cor,], av.exp.cbo[genes2cor,], method = "spearman")
```

```{r}
corr2ons76.cbo.cl
```

```{r}
# save the correlation matrix corr2cbo.cl
saveRDS(corr2ons76.cbo.cl, file = "./outputs50K/ONS76-CBO/CorrelnSpearmanONS76-CBOvsCBOclusters.rds")
```

```{r}
corr2ons76.cbo.cl <- readRDS("outputs50K/ONS76-CBO/CorrelnSpearmanONS76-CBOvsCBOclusters.rds")
```


My cell annotations based on the positive DEGs in each cluster turned out to be accurate
```{r HeatmapONS76CboVSCboClusterCorrelations, fig.height=6, fig.width=6}

heatmap3(corr2ons76.cbo.cl, scale="none", margins=c(15,17),
          labRow = colnames(avg.exp.ons76Cbo), labCol = colnames(av.exp.cbo), cexRow=0.8, cexCol=0.8,
          col=colorRampPalette(rev(c("#b2182b","#d6604d","#f4a582","#fddbc7","#f7f7f7","#d1e5f0","#92c5de","#4393c3","#2166ac")))(30))

```


-----------------------------------------------------------------------------------------------------------
***Identification of healthy and cancerous NEUROD1 clusters in ONS76-CBO sample generated by SCTransform***
The Violin Plot shows that the NEUROD1 clustering using SCTransform() is consistent with the results of conventional normalisation and identifies clusters 4,5,9,12 as the NEUROD1 clusters. Also the other markers allow us to distinguish the healthy from cancerous cells. There are four NEUROD1 clusters in the ONS76-CBO sample, but only one in the CBO sample. The ONS76-CBO sample should contain both healthy and cancerous NEUROD1 cells.
Which ones are the NEUROD1 clusters? In the CBO sample, clustering shows there is only 1 NEUROD1 cluster and this cluster also expresses RBFOX3 and RTN1 (derived from  https://doi.org/10.7554/eLife.37551). We can see that the only cluster that expresses all three genes, as in the NEUROD1 cluster in CBO sample, is cluster 4/'granule precursors'. So cluster 4 NEUROD1+ cells must be the healthy cells and the other three clusters are medulloblastoma clusters that have differentiated. The SCTransform better distinguishes the healthy from the cancerous NEUROD1+ clusters than conventional normalisation
```{r ViolinPlotNeurod1clustersONS76cboSCT, fig.height=9, fig.width=12}
# there are 4 NEUROD1+ clusters
# only cluster 4 expresses NEUROD1, RBFOX3 and RTN1 and must be wild type cells

VlnPlot(o76cbo.annotate, features = c("NEUROD1", "RBFOX3", "RTN1", "NES", "NRG3"))
```

```{r ViolinPlotSox2Pou3f2Erbb4Nrg3ONS76cboSCT, fig.height=9, fig.width=12}
VlnPlot(o76cbo.annotate, features = c("SOX2", "POU3F2", "ERBB4", "NRG3"))
```


***Extract the ONS76 cells/clusters that are NeuroD1+ and then all malignant clusters***. 
There are 634 NEUROD1 positive cells - both healthy and cancerous
```{r}
# FOR KNIT DO NOT RE-RUN THIS CODE CHUNK
# 281 NEUROD1+ cancer cells
neurod1.ons76cbo <- subset(o76cbo, idents = c("3"))
dim(neurod1.ons76cbo)
```


```{r}
# FOR KNIT DO NOT RE-RUN THIS CODE CHUNK

# save the malignant neurod1.ons76cbo clusters 5,9,12 above - this was generated from o76cbo
# regressed SCTransformed seurat object

saveRDS(neurod1.ons76cbo, file = "./outputs50K/ONS76-CBO/neurod1ClustsCancer.CCDiffRegress.noMitoNoRiboSCT.ons76cbo.rds")
```

```{r}
# subset o76cbo.annotate for ALL the malignant clusters 3, 8
o76only.o76cboAnnot <- 
  subset(o76cbo.annotate, 
         idents = c("ONS76_cluster_3", "ONS76_cluster_8"))
```

```{r}
# should rescale the object after subsetting (see https://github.com/satijalab/seurat/issues/2365)
o76only.o76cboAnnot.rescaled <- ScaleData(o76only.o76cboAnnot)
```

```{r}
# change the 'Identity' on x-axis of VlnPlot from numbers only to something more meaningful

new.cluster.ids.subset <- c("ONS76_cluster_3", "ONS76_cluster_8")
names(new.cluster.ids.subset) <- levels(o76only.o76cboAnnot.rescaled)
o76only.o76cboAnnot.rescaled <- RenameIdents(o76only.o76cboAnnot.rescaled, new.cluster.ids.subset)
```

```{r}
# ONS76-CBO, cancer cell numbers: clust 3 = 281 cells, clust 8 = 80 cells
table(o76only.o76cboAnnot.rescaled$seurat_clusters)
```

```{r}
# save all the malignant clusters 3 and 8
saveRDS(o76only.o76cboAnnot.rescaled, 
        file = "./outputs50K/ONS76-CBO/ONS76OnlyCells.SubsetONS76CboSample.Annotated.Rescaled.SCT.NoRiboNoMito.CCdiffRegressed.rds")
```


------------------------------------------------------------------------------------------
***Gene expression in ONS76 cancer clusters 3 and 8***

```{r}
# load the object
o76only.o76cboAnnot.rescaled <- 
  readRDS("outputs50K/ONS76-CBO/ONS76OnlyCells.SubsetONS76CboSample.Annotated.Rescaled.SCT.NoRiboNoMito.CCdiffRegressed.rds")
```

```{r ViolinPlotSox2networkONS76onlyONS76cbo, fig.height=7, fig.width=10}
# plot of the clusters containing granule/RL lineage - clusters 2, 4, 6, 9 and 10 contain RL/granule
# lineage.
# CDH1 is expressed (in WT cells and ONS76 cells), but CDH5 (marker of ONS76 cells) is not expressed.
# CD44 is not expressed or expressed very little.
# ITGB1 is also not good at discriminating WT CBO from ONS76-CBO samples

VlnPlot(o76only.o76cboAnnot.rescaled, 
        features = c("SOX2", "POU3F2", "FABP7", "OTX2", "ZIC2", "GLI2"))
  
```

```{r ViolinPlotERRB4nrg3Meis1ZicONS76onlyONS76cbo, fig.height=7, fig.width=10}
VlnPlot(o76only.o76cboAnnot.rescaled, 
        features = c("ERBB4", "NRG3", "NES", "MEIS1", "OLIG2"))
```

```{r ViolinPlotSHHgenesMycONS76cbo, fig.width=14}
VlnPlot(o76only.o76cboAnnot.rescaled, 
        features = c("GLI2", "GLI3", "PTCH1", "MYC", "MYCN"))
```


---------------------------------------------------------------------------------------------------------
***Gene set enrichment analysis (GSEA) using FGSEA and PRESTO for malignant clusters of ONS76-CBO sample***
from: https://nbisweden.github.io/workshop-scRNAseq/labs/compiled/seurat/seurat_05_dge.html#Gene_Set_Enrichment_Analysis_(GSEA) and https://crazyhottommy.github.io/scRNA-seq-workshop-Fall-2019/scRNAseq_workshop_3.html
PRESTO is good package to use, ranks genes very fast for Gene Set Enrichment analysis

The first website uses the output of Seurat FindMarkers() to generate the gene list, but this does not use all genes. Note that the arguments are different from the standard ones used to generate DEG list.

Get the genes for control CBO sample cluster 5, which I have called granule precursors first and compare the ONS76-CBO sample to the cells in cluster 5 CBO.

```{r}
# load the clusterMap cell, gene, ribo, mito, CC.difference regressed, SCTransformed seurat object
cbo <- 
  readRDS("outputs50K/CBO/ClusterMapInput.Cbo.NoRiboNoMito.SCT.clustered.CCdiffRegressed.rds")
```

```{r}
# apply presto to CBO control
cbo.presto <- wilcoxauc(cbo, 'seurat_clusters')
head(cbo.presto)
```

```{r}
# apply presto to ONS76-CBO sample
o76cbo.presto <- wilcoxauc(o76cbo, 'seurat_clusters')
head(o76cbo.presto)
```

```{r}
# we have all the genes for each cluster
dplyr::count(cbo.presto, group)
```

```{r}
# we have all the genes for each cluster
dplyr::count(o76cbo.presto, group)
```



****Cluster 5 CBO control (granule precursors) including input for gProfiler and Cytoscape****

```{r}
# this code used to generate sorted gene list as input for gProfiler (web app)
cbo.cl5.UPgenes.presto <- cbo.presto %>% 
  dplyr::filter(group == "5" & logFC > 0.25) %>%
  dplyr::arrange(desc(auc)) %>% 
  dplyr::select(feature, auc)

nrow(cbo.cl5.UPgenes.presto) # genes=952
```

```{r}
# save as csv for input to g:Profiler (web app)
write.csv(cbo.cl5.UPgenes.presto, 
          "./outputs50K/CBO/CBO.cluster5.UPgenes.PRESTO.gProfilerInput.csv", 
          quote = F)
```



****Cluster 3 ONS76-CBO - geneset enrichment (FGSEA) including input for g:Profiler and Cytoscape****
```{r}
# filter gene expression for cluster 3, the ONS76 NEUROD1+ cluster
# the presto gene list puts EYA2 and NEUROD1 near the top which is reassuring
o76cbo.presto %>%
  dplyr::filter(group == "3") %>%
  arrange(desc(logFC), desc(auc)) %>%
  head()
```

```{r}
# this code used to generate sorted gene list as input for gProfiler (web app)
ons76cbo.cl3.UPgenes.presto <- o76cbo.presto %>% 
  dplyr::filter(group == "3" & logFC > 0.25) %>%
  dplyr::arrange(desc(auc)) %>% 
  dplyr::select(feature, auc)

nrow(ons76cbo.cl3.UPgenes.presto) # genes=960
```

```{r}
# FOR KNIT DO NOT RE-RUN THIS CODE CHUNK
# save as csv for input to g:Profiler (web app)
write.csv(ons76cbo.cl3.UPgenes.presto, 
          "./outputs50K/ONS76-CBO/ONS76cbo.cluster3.UPgenes.PRESTO.gProfilerInput.csv", 
          quote = F)
```


****ONS76-CBO Cluster 8****
```{r}
o76cbo.presto %>%
  dplyr::filter(group == "8") %>%
  arrange(desc(logFC), desc(auc)) %>%
  head()
```

```{r}
# this code used to generate sorted gene list as input for gProfiler (web app).
ons76cbo.cl8.UPgenes.presto <- o76cbo.presto %>% 
  dplyr::filter(group == "8" & logFC > 0.25) %>%
  dplyr::arrange(desc(auc)) %>% 
  dplyr::select(feature, auc)

nrow(ons76cbo.cl8.UPgenes.presto) # genes = 463 only
```


```{r}
# save as csv for input to g:Profiler (web app)
write.csv(ons76cbo.cl8.UPgenes.presto, 
          "./outputs50K/ONS76-CBO/ONS76cbo.cluster8.UPgenes.PRESTO.gProfilerInput.csv", 
          quote = F)
```


--------------------------------------------------------------------------------------------------
***Examine cell cycle and proliferating cells using AddModuleScore()***
Find the cells that are actively proliferating in this sample
```{r}
s.genes <- cc.genes$s.genes
g2m.genes <- cc.genes$g2m.genes
prolif.genes <- list(c(s.genes, g2m.genes))
```

```{r AddModuleScoreProlifernONS76cbo, fig.height=4}
phase.ons76cbo.sct.clust <- AddModuleScore(phase.ons76cbo.sct.clust,
                        features = prolif.genes,
                        name = "prolif.genes")
FeaturePlot(phase.ons76cbo.sct.clust, features = 'prolif.genes1', label = TRUE, repel = TRUE) +
   scale_colour_gradientn(colours = rev(brewer.pal(n = 11, name = "RdBu")))
```

```
save.image("./RDataFiles/ONS76-CBO_Seurat_EXPLORE1_50K.RData")
```


-------------------------------------------------------------------------------------------
-------------------------------------------------------------------------------------------
UNUSED CODE RETAINED IN CASE IT TURNS OUT TO BE USEFUL
****Cluster 8 GO:BP genesets****

```
{r}
# use dplyr to get the appropriate gene set
msig.hs <- msigdbr(species = "Homo sapiens")

msig.GOBP.hs <- msig.hs %>% 
dplyr::filter(gs_subcat == "GO:BP")

head(msig.GOBP.hs)
```

```
{r}
fgsea_sets_GOBP <- msig.GOBP.hs %>% split(x = .$gene_symbol, f = .$gs_name)
```

```
{r}
# use fgsea 'multilevel' function; the multilevel function has by default NPermSimple=1000

fgseaRes.clus8.GOBP <- 
  fgseaMultilevel(fgsea_sets_GOBP, stats = ranks.clus8, eps = 0, minSize = 15, scoreType = "pos", maxSize = 200)
```

```
{r}
# tidy up the data
fgseaResTidy.clus8.GOBP <- fgseaRes.clus8.GOBP %>%
  as_tibble() %>%
  arrange(desc(NES))

fgseaResTidy.clus8.GOBP %>% 
  dplyr::select(-leadingEdge, -ES) %>% 
  arrange(padj) %>% 
  head(20)
```

```
{r}
# no significant gene sets!
saveRDS(fgseaResTidy.clus8.GOBP, 
        file = "./outputs50K/ONS76-CBO/cluster9.ONS76Cbo.multifgsea.presto.GOBiolProcessGenes.rds")
```

```
{r}
fgseaResTidy.clus8.GOBP <- 
  readRDS("outputs50K/DAOY-CBO/outputs50K/ONS76-CBO/cluster8.ONS76Cbo.multifgsea.presto.GOBiolProcessGenes.rds")
```


```
{r BarplotFGSEAgoBPclust8DaoyCbo, fig.height=5, fig.width=6}
# only plot the top 20 pathways - no enriched gene sets!
ggplot(fgseaResTidy.clus8.GOBP %>% filter(padj < 0.001) %>% head(n=20), aes(reorder(pathway, NES), NES)) +
  geom_col(fill = "blue") +
  coord_flip() +
  labs(x="Pathway", y="Normalized Enrichment Score",
       title= "GO:BP pathways NES from GSEA") + 
  theme_minimal() # can change bar colours using ggplot
```

```
{r}
# continue with preparing data for input to fgsea and getting bar charts of gene set 
# enrichment analysis
clust8.genes.presto <- o76cbo.presto %>%
  dplyr::filter(group == "8") %>%
  arrange(desc(auc)) %>% 
  dplyr::select(feature, auc)
```

```
{r}
ranks.clus8 <- deframe(clust8.genes.presto)
head(ranks.clus8)
```

```
{r}
H.geneset <- msigdbr(species = "Homo sapiens", category = "H")
head(H.geneset)
```

```
{r}
fgsea_sets <- H.geneset %>% split(x = .$gene_symbol, f = .$gs_name)
```

```
{r}
# set eps to zero to get lower p-values
fgseaRes.clus8.hallmark <- 
  fgseaMultilevel(fgsea_sets, eps = 0, stats = ranks.clus8, minSize = 15, scoreType = "pos", maxSize = 200)
```

```
{r}
# there are no significant gene sets with padj<0.05
fgseaResTidy.clus8.hallmark <- fgseaRes.clus8.hallmark %>%
  as_tibble() %>%
  dplyr::arrange(desc(NES))

fgseaResTidy.clus8.hallmark %>% 
  dplyr::select(-leadingEdge, -ES) %>% 
  dplyr::arrange(padj) %>% 
  head(10)
```

```
{r}
saveRDS(fgseaResTidy.clus9.hallmark,
        file = "./outputs50K/ONS76-CBO/cluster9.ons76cbo.multifgsea.presto.HallmarkGenes.rds")
```

```
{r}
fgseaResTidy.clus8.hallmark <- 
  readRDS("outputs50K/ONS76-CBO/cluster8.ons76cbo.multifgsea.presto.HallmarkGenes.rds")
```


```
{r BarplotFGSEAgoBPclust8ons76Cbo, fig.height=5, fig.width=6}
# only plot the top 20 pathways - NO ENRICHED PATHWAYS!!!
ggplot(fgseaResTidy.clus8.hallmark %>% filter(padj < 0.05) %>% head(n=20), aes(reorder(pathway, NES), NES)) +
  geom_col(fill = "blue") +
  coord_flip() +
  labs(x="Pathway", y="Normalized Enrichment Score",
       title= "GO:BP pathways NES from GSEA") + 
  theme_minimal() # can change bar colours using ggplot
```

****Cluster 5 - HALLMARK genesets****
The Hallmark genesets are enriched for 'mitotic spindle', MYC targets, E2F targets - i.e. all cell cycle related - and this is quite similar to the healthy granule cluster, cluster 4 which could explain why the correlation heatmap and the UMAP plots show cluster 4 next to cluster 3.
```
{r}
H.geneset <- msigdbr(species = "Homo sapiens", category = "H")
head(H.geneset)
```

```
{r}
fgsea_sets <- H.geneset %>% split(x = .$gene_symbol, f = .$gs_name)
```

```
{r}
# set eps to zero to get lower p-values
fgseaRes.clus3.hallmark <- 
  fgseaMultilevel(fgsea_sets, eps = 0, stats = ranks.clus3, minSize = 15, scoreType = "pos", maxSize = 200)
```

```
{r}
fgseaResTidy.clus3.hallmark <- fgseaRes.clus3.hallmark %>%
  as_tibble() %>%
  dplyr::arrange(desc(NES))

fgseaResTidy.clus3.hallmark %>% 
  dplyr::select(-leadingEdge, -ES) %>% 
  dplyr::arrange(padj) %>% 
  head(5)
```

```
{r}
saveRDS(fgseaResTidy.clus3.hallmark,
        file = "./outputs50K/ONS76-CBO/cluster3.ons76cbo.multifgsea.presto.HallmarkGenes.rds")
```

```
{r}
fgseaResTidy.clus3.hallmark <- 
  readRDS("outputs50K/ONS76-CBO/cluster3.ons76cbo.multifgsea.presto.HallmarkGenes.rds")
```


```
{r BarplotFGSEAmsigdbHallmarkClust5ons76cbo, fig.height=5, fig.width=6}
# only plot the top 20 pathways, but note the 'padj' filter which will limit the number of plotted
# genesets to the top few

ggplot(fgseaResTidy.clus3.hallmark %>% filter(padj < 0.001) %>% head(n=20), aes(reorder(pathway, NES), NES)) +
  geom_col(aes(fill = NES > 0)) +
  coord_flip() +
  labs(x="Pathway", y="Normalized Enrichment Score",
       title="Hallmark Pathways NES from GSEA") + 
  theme_minimal()
```

****Cluster 3 - GO:BP genesets****
```
{r}
# use dplyr to get the appropriate gene set
msig.hs <- msigdbr(species = "Homo sapiens")

msig.GOBP.hs <- msig.hs %>% 
dplyr::filter(gs_subcat == "GO:BP")

head(msig.GOBP.hs)
```

```
{r}
fgsea_sets_GOBP <- msig.GOBP.hs %>% split(x = .$gene_symbol, f = .$gs_name)
```

```
{r}
# use fgsea 'multilevel' function; the multilevel function has by default NPermSimple=1000

fgseaRes.clus3.GOBP <- 
  fgseaMultilevel(fgsea_sets_GOBP, stats = ranks.clus3, eps = 0, minSize = 15, scoreType = "pos", maxSize = 200)
```

```
{r}
# tidy up the data
fgseaResTidy.clus3.GOBP <- fgseaRes.clus3.GOBP %>%
  as_tibble() %>%
  arrange(desc(NES))

fgseaResTidy.clus3.GOBP %>% 
  dplyr::select(-leadingEdge, -ES) %>% 
  arrange(padj) %>% 
  head(20)
```


```
{r}
saveRDS(fgseaResTidy.clus3.GOBP, 
        file = "./outputs50K/ONS76-CBO/cluster3.ONS76Cbo.multifgsea.presto.GOBiolProcessGenes.rds")
```

```
{r}
fgseaResTidy.clus5.GOBP <- 
  readRDS("outputs50K/ONS76-CBO/cluster3.ONS76Cbo.multifgsea.presto.GOBiolProcessGenes.rds")
```


```
{r BarplotFGSEAgoBPclust3ONS76Cbo, fig.height=5, fig.width=6}
# only plot the top 20 pathways
ggplot(fgseaResTidy.clus3.GOBP %>% filter(padj < 0.001) %>% head(n=20), aes(reorder(pathway, NES), NES)) +
  geom_col(fill = "blue") +
  coord_flip() +
  labs(x="Pathway", y="Normalized Enrichment Score",
       title= "GO:BP pathways NES from GSEA") + 
  theme_minimal() # can change bar colours using ggplot
```

```
{r}
# continue with preparing data for input to fgsea and getting bar charts of gene set 
# enrichment analysis
clust3.genes.presto <- o76cbo.presto %>%
  dplyr::filter(group == "3") %>%
  arrange(desc(auc)) %>% 
  dplyr::select(feature, auc)
```

```
{r}
ranks.clus5 <- deframe(clust5.genes.presto)
head(ranks.clus3)
```

Test the gene set enrichment of cluster 5 in CBO, the granule cell cluster
```
{r}
# continue with preparing data for input to fgsea and getting bar charts of gene set 
# enrichment analysis
clust5.cbo.genes.presto <- cbo.presto %>%
  dplyr::filter(group == "5" & !(feature == "MALAT1")) %>%
  dplyr::arrange(desc(auc)) %>% 
  dplyr::select(feature, auc)
```

```
{r}
ranks.clus5 <- deframe(clust5.cbo.genes.presto)
head(ranks.clus5)
```

```
{r}
H.geneset <- msigdbr(species = "Homo sapiens", category = "H")
head(H.geneset)
```

```
{r}
fgsea_sets <- H.geneset %>% split(x = .$gene_symbol, f = .$gs_name)
```

```
{r}
# set eps to zero to get lower p-values
fgseaRes.clus5.hallmark <- 
  fgseaMultilevel(fgsea_sets, eps = 0, stats = ranks.clus5, minSize = 15, scoreType = "pos", maxSize = 200)
```

```
{r}
# top GO terms are related to proliferation not neuronal differentiation! Consistent with this
# granule cluster being composed of granule precursors
fgseaResTidy.clus5.hallmark <- fgseaRes.clus5.hallmark %>%
  as_tibble() %>%
  dplyr::arrange(desc(NES))

fgseaResTidy.clus5.hallmark %>% 
  dplyr::select(-leadingEdge, -ES) %>% 
  dplyr::arrange(padj) %>% 
  head(10)
```

```
{r}
saveRDS(fgseaResTidy.clus5.hallmark,
        file = "./outputs50K/CBO/granule.cluster5.cbo.multifgsea.presto.HallmarkGenes.rds")
```

```
{r}
fgseaResTidy.clus5.hallmark <- 
  readRDS("outputs50K/CBO/granule.cluster5.cbo.multifgsea.presto.HallmarkGenes.rds")
```


The GO:BP enrichments clearly show these granule 'neurons' are unlikely to be terminally differentiated and are still proliferative. This is why cluster 5,9,11 in ONS76-CBO  have a gene expression profile of proliferative cells and that is correlated (Spearman correlation) with the gene expression profile of cluster 6 granule cells in the CBO control.

```
{r BarplotFGSEAmsigdbHALLMARKclust4granuleCbo, fig.height=2, fig.width=3}
# only plot the top 20 pathways, but note the 'padj' filter which will limit the number of plotted
# genesets to the top few

ggplot(fgseaResTidy.clus5.hallmark %>% filter(padj < 0.001) %>% head(n=20), aes(reorder(pathway, NES), NES)) +
  geom_col(aes(fill = NES > 0)) +
  coord_flip() +
  labs(x="Pathway", y="Normalized Enrichment Score",
       title="Hallmark Pathways NES from GSEA") + 
  theme_minimal()
```

-------------------------------------------------------------------------------------------
-------------------------------------------------------------------------------------------
***Get the differentially expressed genes in the 11 ONS76-CBO clusters using a FOR loop***
Getting cluster markers this way is less efficient than using FindAllMarkers() command!
```
{r}
# FOR KNIT DO NOT RE-RUN THIS CODE CHUNK

Idents(phase.ons76cbo.sct.clust) <- "seurat_clusters"
markers.pos <- data.frame()
for (i in levels(Idents(phase.ons76cbo.sct.clust))){
  markers <- FindMarkers(phase.ons76cbo.sct.clust, ident.1 = i, grouping.var = "ident", 
                         verbose = FALSE, only.pos = TRUE, logfc.threshold = 0.25)
  dat <- markers %>% rownames_to_column(var = "genes")
  dat$cluster_ID <- i
  dat$cluster_ID <- as.numeric(dat$cluster_ID)
  df <- data.frame(dat)
  markers.pos <- rbind(markers.pos, df)
}
head(markers.pos)
```


-----------------------------------------------------------------------------------
***Expression of specific marker genes of each cluster in phase SCTransformed ONS76-CBO seurat object***
This type of plot was not that useful
```
{r DotplotAllSeppMarkersAndCiliaONS76cbo, fig.height=10}
# from the Sepp paper repeat Dotplot with TF and some key non-TF markers
# added markers of ciliated cells from cluster10 above.
# used the argument col.min = 0 so that average expression scale is from 0 to 2.5 in key

sepp.all.markers <- c("TFAP2A", "PAX3", "RFX4", "TCFL71", "TCF7L2", "GLIS3", "SOX6", "HOPX", "TSC22D4",  
                      "ID4", "NCKAP5", "SLIT2", "CLYBL", "SLC1A3", "SLC6A11", "AQP4",  #astroglial/progenitor
                      
                      "ESRRB", "FOXP1", "FOXP2", "FOXP4", "MEF2C", "RORB", "CDH9", "ETV1", "EBF1", "EBF2", 
                      "SKOR2", "DAB1", "IPTR",   # Purkinje
                      
                      "NOTCH1",    # VZ neuroblast
             
                      "PAX2", "NFIA", "NFIB", "TFAP2B", "BHLHE22", "PRDM8",  # interneuron
                      
                      "ZFHX3", "ZFHX4",   # GABAergic deep nuclei neurons
             
                      "TOP2A", "ATOH1", "LMX1A", "OTX2","ETV6", "PAX6", "BARHL1", "E2F3", "ST18", "SATB2", 
                      "ZBTB18", "NEUROD1", "ZIC1", "ZIC4", "GABAR6", "CNTN1", "CNTN2", "KLF9", "NR3C1", "LMO3", 
                      "SYNPR", "KCNIP4", "HCRTR2", 
                      "EOMES", "TRPC3", "GRM1")
                      # UBC/GCP/granule/glut deep cerebellar nuclei                                                                   
seppAll.cilia.stem.markers <- c(sepp.all.markers, "CCNO", "CFAP299", "ROPN1L", "C11orf88", "ANKRD66", "C20orf85", 
                                "STOML3", "TEKT4", "SNTN", "MEIS1", "POU3F2", "HOXB2", "MEIS2", "GRIA4")

DotPlot(object = phase.ons76cbo.sct.clust, features = seppAll.cilia.stem.markers, col.min = 0) +
  coord_flip()
```


# code below is in case I need to check expression of specific gene(s) in certain clusters.
```
# CHECK ABOVE CANDIDATE GENES WHICH ARE UPREGULATED IN ONS76 CELLS VS WT CELLS IN CO-CULTURE
#----------------------------------------------------------------------------------------------------

cntn2.clusters.2.10 <- ons76cbo.cluster.markers.noRiboMito[((ons76cbo.cluster.markers.noRiboMito$cluster == 2 | ons76cbo.cluster.markers.noRiboMito$cluster == 10) & ons76cbo.cluster.markers.noRiboMito$gene == "CNTN2"), ]

cntn2.clusters.2.10
```
# code below is not needed as Venn diagrams are not the correct way to compare gene expression in cells from different clusters. However, it is retained in case Venn Diagrams of expressed genes are useful in future.
***Venn diagrams for overlap of upregulated genes***

```
cluster2.markers <- ons76cbo.cluster.markers.noRiboMito[ons76cbo.cluster.markers.noRiboMito$cluster == 2, ]
cluster6.markers <- ons76cbo.cluster.markers.noRiboMito[ons76cbo.cluster.markers.noRiboMito$cluster == 6, ]
cluster9.markers <- ons76cbo.cluster.markers.noRiboMito[ons76cbo.cluster.markers.noRiboMito$cluster == 9, ]
cluster10.markers <- ons76cbo.cluster.markers.noRiboMito[ons76cbo.cluster.markers.noRiboMito$cluster == 10, ]
```

```
write.csv(cluster2.markers, file = "./outputs50K/DEG_VennDiag/ONS76cbo_cluster2.csv")
write.csv(cluster6.markers, file = "./outputs50K/DEG_VennDiag/ONS76cbo_cluster6.csv")
write.csv(cluster9.markers, file = "./outputs50K/DEG_VennDiag/ONS76cbo_cluster9.csv")
write.csv(cluster10.markers, file = "./outputs50K/DEG_VennDiag/ONS76cbo_cluster10.csv")
```

```
ONS76cbo_clus2 <- read.csv("outputs50K/DEG_VennDiag/ONS76cbo_cluster2.csv",
                           header = TRUE,
                           stringsAsFactors = FALSE)
ONS76cbo_clus6 <- read.csv("outputs50K/DEG_VennDiag/ONS76cbo_cluster6.csv",
                           header = TRUE,
                           stringsAsFactors = FALSE)
ONS76cbo_clus9 <- read.csv("outputs50K/DEG_VennDiag/ONS76cbo_cluster9.csv",
                           header = TRUE,
                           stringsAsFactors = FALSE)
ONS76cbo_clus10 <- read.csv("outputs50K/DEG_VennDiag/ONS76cbo_cluster10.csv",
                           header = TRUE,
                           stringsAsFactors = FALSE)
cbo_clus6_granule <- read.csv("outputs50K/DEG_VennDiag/cbo_cluster6_granule.csv",
                           header = TRUE,
                           stringsAsFactors = FALSE)
```

``` VennDiagClus6CBOvsClus6ONS76CBO
gene_list1 <- list(cbo_clus6_granule$gene, ONS76cbo_clus6$gene)
cbo.clus6.granule_ons76cbo.clus6 <- ggVennDiagram(gene_list1, category.names = c("cbo_clus6_granule", "ONS76cbo_clus6"))
cbo.clus6.granule_ons76cbo.clus6
```

```VennDiagClus6CBOvsClus2ONS76CBO
# cluster 2 in ONS76-CBO and cluster 6 in CBO seem to share the greatest percentage of genes,
# so it is likely that CBO cluster 6 and ONS76-CBO cluster 2 are the most similar

gene_list2 <- list(cbo_clus6_granule$gene, ONS76cbo_clus2$gene)
cbo.clus6.granule_ons76cbo.clus2 <- ggVennDiagram(gene_list2, category.names = c("cbo_clus6_granule", "ONS76cbo_clus2"))
cbo.clus6.granule_ons76cbo.clus2
```

```VennDiagClus6CBOvsClus9ONS76CBO
gene_list3 <- list(cbo_clus6_granule$gene, ONS76cbo_clus9$gene)
cbo.clus6.granule_ons76cbo.clus9 <- ggVennDiagram(gene_list3, category.names = c("cbo_clus6_granule", "ONS76cbo_clus9"))
cbo.clus6.granule_ons76cbo.clus9
```

```VennDiagClus6CBOvsClus10ONS76CBO
gene_list4 <- list(cbo_clus6_granule$gene, ONS76cbo_clus10$gene)
cbo.clus6.granule_ons76cbo.clus10 <- ggVennDiagram(gene_list4, category.names = c("cbo_clus6_granule", "ONS76cbo_clus10"))
cbo.clus6.granule_ons76cbo.clus10
```

----------------------------------------------------------------------------------------------------
***Generate correlation matrix of gene expression in each of the NEUROD1+ clusters of ONS76-CBO and CBO control***
Find AverageExpression() of each of the NEUROD1+ clusters, and eventually construct a dataframe of the Average Expression of all 4 NEUROD1+ clusters. The aim is to generate a correlation matrix, first using all the genes, and then using the top 500 DEGs of each cluster.
```
{r}
av.exp.cl5.cbo <- AverageExpression(nd1.clus5.cbo)$RNA
head(av.exp.cl5.cbo)
```

Is the above result the same as if I do AverageExpression on all the seurat clusters? YES!!
```
{r}
# converted to a dataframe (original data structure is matrix)
av.exp.all <- as.data.frame(AverageExpression(phase.cbo.sct.clust)$RNA)
head(av.exp.all)
```

```
{r}
class(av.exp.all)
```


```
{r}
# subset each NEUROD1 cluster in the ONS76-CBO sample (cluster 9 is NOT a NeuroD1 cluster!)
nd1.cl3.ons76cbo <- subset(phase.ons76cbo.sct.clust, idents = c("3"))

nd1.cl4.ons76cbo <- subset(phase.ons76cbo.sct.clust, idents = c("4"))

nd1.cl8.ons76cbo <- subset(phase.ons76cbo.sct.clust, idents = c("8"))

cl9.ons76cbo <- subset(phase.ons76cbo.sct.clust, idents = c("9")) 

```

```
{r}
# compute AverageExpression of each of the ONS76-CBO NEUROD1+ clusters
av.exp.cl3.ons76cbo <- AverageExpression(nd1.cl3.ons76cbo)$RNA
av.exp.cl4.ons76cbo <- AverageExpression(nd1.cl4.ons76cbo)$RNA
av.exp.cl8.ons76cbo <- AverageExpression(nd1.cl8.ons76cbo)$RNA
av.exp.cl9.ons76cbo <- AverageExpression(cl9.ons76cbo)$RNA
```

Check lengths of the objects. They are different. Cluster 5 from the CBO control has the largest number of genes 
```
{r}
length(av.exp.cl5.cbo)
length(av.exp.cl3.ons76cbo)
length(av.exp.cl4.ons76cbo)
length(av.exp.cl8.ons76cbo)
length(av.exp.cl9.ons76cbo)
```

```
{r}
# change colnames of objects (clusters)
colnames(av.exp.cl5.cbo) <- "cl5_cbo"
colnames(av.exp.cl3.ons76cbo) <- "cl3_ons76cbo"
colnames(av.exp.cl4.ons76cbo) <- "cl4_ons76cbo"
colnames(av.exp.cl8.ons76cbo) <- "cl8_ons76cbo"
colnames(av.exp.cl9.ons76cbo) <- "cl9_ons76cbo"
```

Make the rownames (which are gene symbols) of each of the "av.exp..." objects into a new column  with rownames_to_column(). First convert the object to a dataframe.
```
{r}
av.exp.cl5.cbo.2cols <- as.data.frame(av.exp.cl5.cbo) %>% 
  rownames_to_column("genes")
av.exp.cl3.ons76cbo.2cols <- as.data.frame(av.exp.cl3.ons76cbo) %>% 
  rownames_to_column("genes")
av.exp.cl4.ons76cbo.2cols <- as.data.frame(av.exp.cl4.ons76cbo) %>% 
  rownames_to_column("genes")
av.exp.cl8.ons76cbo.2cols <- as.data.frame(av.exp.cl8.ons76cbo) %>% 
  rownames_to_column("genes")
av.exp.cl9.ons76cbo.2cols <- as.data.frame(av.exp.cl9.ons76cbo) %>% 
  rownames_to_column("genes")
```

This worked, as shown by below example
```
{r}
head(av.exp.cl5.cbo.2cols)
```

Are there any duplicate genes in the ONS76-CBO sample? No
```
{r}
sum(duplicated(av.exp.cl3.ons76cbo.2cols))
sum(duplicated(av.exp.cl4.ons76cbo.2cols))
sum(duplicated(av.exp.cl8.ons76cbo.2cols))
```

Are there any duplicated genes in the CBO sample? No
```
{r}
sum(duplicated(av.exp.cl5.cbo.2cols))
```

Are the genes in 'av.exp.cl5.cbo.2cols' the same as the genes in 'av.exp.cl4.ons76cbo.2cols$genes'. NO!!
```
{r}
# compare the genes in Cluster 5 of CBO and Cluster 4 of ONS76-CBO sample - they are NOT identical
identical(av.exp.cl5.cbo.2cols$genes, av.exp.cl4.ons76cbo.2cols$genes)
```

Are the genes in NeuroD1 cluster 3, 4, 8 of the ONS76-CBO sample identical - they are.
```
{r}
# compare the genes in Cluster 3 and Cluster 4 of ONS76-CBO sample - they are identical
identical(av.exp.cl3.ons76cbo.2cols$genes, av.exp.cl4.ons76cbo.2cols$genes)
```

```
{r}
# compare the genes in Cluster 4 of ONS76-CBO and Cluster 8 of ONS76-CBO samples - they are identical
identical(av.exp.cl4.ons76cbo.2cols$genes, av.exp.cl8.ons76cbo.2cols$genes)
```

Join the 'av.exp..' dataframes by "genes" so that all the 'genes' in the smaller dfs are kept and the genes that are in the longer df that are not also present in the shorter dfs are removed

```
{r}
merge3 <- join_all(list(av.exp.cl3.ons76cbo.2cols, 
                        av.exp.cl4.ons76cbo.2cols, 
                        av.exp.cl8.ons76cbo.2cols,
                        av.exp.cl9.ons76cbo.2cols,
                        av.exp.cl5.cbo.2cols), 
                       by = "genes", type = "left")
head(merge3)
```

```
{r}
colSums(is.na(merge3))
```

```
{r}
# Replace all the NA values with zeros
merge3[is.na(merge3)] <- 0
colSums(is.na(merge3))
```

```
{r}
# check expression of NEUROD1, RBFOX3 and RTN1
merge3 %>% 
  filter(genes %in% c("NEUROD1", "RBFOX3", "RTN1", "MEIS1", "CNTN2"))
```


```
{r}
# save the 'merge3' object which is the Average Expression of all the clusters (NA values removed)
saveRDS(merge3, 
        file = "./outputs50K/ONS76-CBO/neurod1ClustsANDons76CboClus9.ons76cbo.cbo.allGenes.AvgExpressn.dataframe.rds")
```

```
{r}
# load the AverageExpression dataframe containing ALL genes
merge3 <- 
  readRDS("outputs50K/ONS76-CBO/neurod1ClustsANDons76CboClus9.ons76cbo.cbo.allGenes.AvgExpressn.dataframe.rds")
```

****Correlation matrix using ALL genes****
The correlation matrix below shows the correlation strength when comparing Average Expression of ALL genes in the matrix. However, plotting the correlation matrix in this form will not look good!
```
{r}
# use dplyr to select only the columns with numeric values (the RNA counts)
RNAcounts <- merge3 %>% 
  select(-genes)

ons76cbo.cor <- cor(RNAcounts[, colnames(RNAcounts) != "cl5_cbo"], RNAcounts$cl5_cbo)
ons76cbo.cor
```

Get the full correlation matrix - correlation between all clusters
```
{r}
corr.ons76sbo.cbo <- cor(RNAcounts)
corr.ons76sbo.cbo
```

Refer to https://dk81.github.io/dkmathstats_site/rvisual-corrplots.html to plot this upper triangular correlation plot
```
{r}
upper.ons76cbo.cbo <- corr.ons76sbo.cbo

# Make upper triangular matrix by setting NA to lower triangular part:
upper.ons76cbo.cbo[lower.tri(upper.ons76cbo.cbo)] <- NA
upper.ons76cbo.cbo
```

```
{r}
# Melt this upper triangular matrix (package reshape2 needed) and remove NA values:
up.m.ons76cbo.cbo <- melt(upper.ons76cbo.cbo, na.rm = TRUE)
head(up.m.ons76cbo.cbo)
nrow(up.m.ons76cbo.cbo)
```

This is a much nicer looking plot - the CORRELATION HEATMAP FOR ALL GENES
```
{r CorrAllGenesNeurod1ClustsONS76cboVScbo}
# ggplot upper triangular correlation matrix:
ggplot(data = up.m.ons76cbo.cbo, aes(x = Var1, y = Var2, fill = value)) +
  geom_tile() +
  theme_classic() +
  labs(x = "", y = "", fill = "Correlation \n Measure \n") +
  scale_x_discrete(labels = c("Clust 3_ONS76-CBO", 
                              "Clust 4_ONS76-CBO",
                              "Clust 8_ONS76-CBO",
                              "Clust 9_ONS76-CBO",
                              "Clust 5_CBO")) +
  scale_y_discrete(labels = c("Clust 3_ONS76-CBO", 
                              "Clust 4_ONS76-CBO",
                              "Clust 8_ONS76-CBO",
                              "Clust 9_ONS76-CBO",
                              "Clust 5_CBO")) +
  theme(axis.text.x = element_text(face = "bold", angle = 90, hjust = 1),
        axis.text.y = element_text(face = "bold", vjust = 1),
        axis.ticks = element_blank(),
        axis.line = element_line(linetype = "blank"),
        panel.background = element_rect(fill = "gray87"),
        panel.grid.major = element_line(colour = "gray47", linetype = "dotted", size = 0.2)
        ) +
  geom_text(aes(label = round(value, 3)), color = "white", fontface = "bold", size = 3) +
  coord_fixed()
```

***Test whether it is better to select the top DEGs, using FindMarkers, in the healthy CBO NEUROD1 cluster 5 rather than all genes as I have done.*** 
It is NOT better to select the top DEGs than useing all genes
Note I am using the SCTransformed, CC difference regressed 'phase' object

```
# NO NEED TO RE-RUN THESE CODE CHUNKS

# choose top 500 DEGs of cluster 5 of CBO sample
cl5.cbo.sct.DEG <- FindMarkers(object = phase.cbo.sct.clust,
                                    ident.1 = 5,
                                    min.pct = 0.5)
cl5.cbo.top500DEG <- head(cl5.cbo.sct.DEG, n = 500)
head(cl5.cbo.top500DEG, n=10)
```

Find the top 500 DEGs in each of the 3 clusters in ONS76-CBO sample, generated after applying SCTransform
```
# choose top 500 DEGs of cluster 3 of ONS76-CBO sample
cl3.ons76cbo.sct.DEG <- FindMarkers(object = phase.ons76cbo.sct.clust,
                                    ident.1 = 3,
                                    min.pct = 0.5)
cl3.ons76cbo.top500DEG <- head(cl3.ons76cbo.sct.DEG, n = 500)
head(cl3.ons76cbo.top500DEG, n=10)
```
```
# choose top 500 DEGs of cluster 4 of ONS76-CBO sample
cl4.ons76cbo.sct.DEG <- FindMarkers(object = phase.ons76cbo.sct.clust,
                                    ident.1 = 4,
                                    min.pct = 0.5)
cl4.ons76cbo.top500DEG <- head(cl4.ons76cbo.sct.DEG, n = 500)
head(cl4.ons76cbo.top500DEG, n=10)
```

```
# choose top 500 DEGs of cluster 8 of ONS76-CBO sample
cl8.ons76cbo.sct.DEG <- FindMarkers(object = phase.ons76cbo.sct.clust,
                                    ident.1 = 8,
                                    min.pct = 0.5)
cl8.ons76cbo.top500DEG <- head(cl8.ons76cbo.sct.DEG, n = 500)
head(cl8.ons76cbo.top500DEG, n=10)
```

So, now we have 500 DEGs for each of our 4 clusters, we need to extract the RNA counts for each DEG for each cluster from merge3 which already has all counts for all genes, including these.
```
cl5.cbo.top500DEG.2 <- cl5.cbo.top500DEG %>% 
  rownames_to_column(var = "gene")

cl3.ons76cbo.top500DEG.2 <- cl3.ons76cbo.top500DEG %>% 
  rownames_to_column(var = "gene")

cl4.ons76cbo.top500DEG.2 <- cl4.ons76cbo.top500DEG %>% 
  rownames_to_column(var = "gene")

cl8.ons76cbo.top500DEG.2 <- cl8.ons76cbo.top500DEG %>% 
  rownames_to_column(var = "gene")

allcl.deg <- rbind(cl5.cbo.top500DEG.2,
                   cl3.ons76cbo.top500DEG.2, 
                   cl4.ons76cbo.top500DEG.2,
                   cl8.ons76cbo.top500DEG.2)

genes.deg <- allcl.deg %>% 
  select(gene)

str(genes.deg)
```

```
# convert gene.vec to a vector
gene.vec <- genes.deg$gene
str(gene.vec)
```

```
# count the number of duplicates
sum(duplicated(gene.vec))
```

```
# get rid of duplicates in the vector 'gene.vect'
gene.vec.uniq <- gene.vec %>% 
  unique()
length(gene.vec.uniq)
```

```
# subset merge3 dataframe so we only keep these 1196 genes
merge3.deg <- merge3 %>% 
  filter(genes %in% gene.vec.uniq)
dim(merge3.deg)
```

```
# save merge3.deg which only contains a subset of genes of merge3, corresponding to DEG genes of all
# the NeuroD1+ clusters from ONS76-CBO and CBO control samples
saveRDS(merge3.deg, file = "outputs50K/ONS76-CBO/neurod1Clusts.ons76cbo.cbo.DEGgenes.AvgExpressn.dataframe.rds")
```

```
{r}
# load the AverageExpression dataframe containing only DEGs
merge3.deg <- readRDS("outputs50K/ONS76-CBO/neurod1Clusts.ons76cbo.cbo.DEGgenes.AvgExpressn.dataframe.rds")
```


The correlation is maximal for cluster 4 in the ON76-CBO sample with cluster 5 of the CBO sample. This means, cluster 4 in ONS76-CBO is the healthy cluster. After repeating the correlation using just (top 500) DEGs, the result is pretty similar to using the entire gene set of ~20K genes
```
{r}
# use dplyr to select only the columns with numeric values (the RNA counts)
RNAcounts.degs <- merge3.deg %>% 
  select(-genes)

ons76cbo.cor.degs <- cor(RNAcounts.degs[, colnames(RNAcounts.degs)], RNAcounts.degs$cl5_cbo)
ons76cbo.cor.degs
```

```
{r}
# convert to dataframe
ons76cbo.cor.degs.df <- as.data.frame(ons76cbo.cor.degs) %>% 
  rownames_to_column(var = "cluster")
```

```
{r}
# overview of object
str(ons76cbo.cor.degs.df)
```

```
{r}
ons76cbo.cor.degs.df$V2 <- "cl5_cbo"
str(ons76cbo.cor.degs.df)
```

This heatmap shows that the correlation plot works and that cluster 4 of ONS76-CBO has the greatest similarity to cluster 5 CBO, which was the expected result. However, using a subset of genes of merge 3, that are DEGs of each cluster is no better than using the full list of genes. The findings are consistent using either the full list of genes or just the DEGs of each cluster. This heatmap appearance is just shown as an example as this plot is not of publication quality!
```
{r CorrlnPlotHealthyNeuroD1VsHealthyAndONS76cocultNeuroD1}
ggplot(data = ons76cbo.cor.degs.df, aes(x = cluster, y = V2, fill = V1)) +
  geom_tile() +
  coord_fixed() +
  theme_classic()
```

A better way to show the correlation using just DEGs is with the upper triangular matrix plot. Start by generating the correlation matrix as before
```
{r}
# generate correlation matrix
corr.ons76sbo.cbo.degs <- cor(RNAcounts.degs)
corr.ons76sbo.cbo.degs
```

```
{r}
upper.ons76cbo.cbo.degs <- corr.ons76sbo.cbo.degs

# Make upper triangular matrix by setting NA to lower triangular part:
upper.ons76cbo.cbo.degs[lower.tri(upper.ons76cbo.cbo.degs)] <- NA
upper.ons76cbo.cbo.degs
```

```
{r}
# 'Melt' this upper triangular matrix (package reshape2 needed) and remove NA values:
up.m.ons76cbo.cbo.degs <- melt(upper.ons76cbo.cbo.degs, na.rm = TRUE)
head(up.m.ons76cbo.cbo.degs)
```

```
{r CorrlnPlotNeuroD1ons76cocultCboSampleAllgenes}
# ggplot upper triangular correlation matrix:
ggplot(data = up.m.ons76cbo.cbo.degs, aes(x = Var1, y = Var2, fill = value)) +
  geom_tile() +
  theme_classic() +
  labs(x = "", y = "", fill = "Correlation \n Measure") +
  scale_x_discrete(labels = c("Clust 3_ONS76-CBO", 
                              "Clust 4_ONS76-CBO",
                              "Clust 8_ONS76-CBO",
                              "Clust 5_CBO")) +
  scale_y_discrete(labels = c("Clust 3_ONS76-CBO", 
                              "Clust 4_ONS76-CBO",
                              "Clust 8_ONS76-CBO",
                              "Clust 5_CBO")) +
  theme(axis.text.x = element_text(face = "bold", angle = 90, hjust = 1),
        axis.text.y = element_text(face = "bold", vjust = 1),
        axis.ticks = element_blank(),
        axis.line = element_line(linetype = "blank"),
        panel.background = element_rect(fill = "gray87"),
        panel.grid.major = element_line(colour = "gray47", linetype = "dotted", size = 0.2)
        ) +
  geom_text(aes(label = round(value, 3)), color = "white", fontface = "bold", size = 4) +
  coord_fixed()
```






















