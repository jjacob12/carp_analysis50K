---
title: "INTEGRATE_ONS76-CBO_ONS76-2D_ONS76-SPHER_CBO_seurat_50K"
author: "JJ"
date: "29/08/2022"
output: html_document
---

```{r graphical_output}
options(bitmapType='cairo-png') # this line of code needed BEFORE knitr code in chunk below
```

```{r setup, include=FALSE}
knitr::opts_chunk$set(dev = "png",
                      dpi = 300,
                      echo = TRUE,   # prints the code (if FALSE then only code output is shown)
                      cache = TRUE,
                      fig.path = "./outputs50K/INTEGRATE/figures_ONS76/")
```

```{r load_libraries}
# library(presto)
suppressPackageStartupMessages({
library(Seurat)
library(glmGamPoi)
library(Matrix)
library(patchwork)
library(clustree)
library(EnhancedVolcano)
library(tidyverse)
# library(reshape2) not needed for base R Pearson correlation plots
})
```

```
{r}

load("RDataFiles/INTEGRATE_ONS76-CBO_ONS76-2D_ONS76-SPHER_CBO_seurat_50K.RData")
```

----------------------------------------------------------------------------------------------------
***INTEGRATED analysis of ONS76-only cells from ONS76-CBO, ONS76-SPHER cells and ONS76-2D cells using SCTransform***

```{r}
# load datasets
# ONS76-2D dataset
o76mono <- readRDS("outputs50K/ONS76_2D/ONS76mono.inputIntegration.SCTransformed.CCdiffRegressed.PCA.unclustered.rds")
# ONS76-SPHER dataset
o76spher <- readRDS("outputs50K/ONS76_SPHER/ONS76spher.inputIntegration.SCTransformed.CCdiffRegressed.PCA.unclustered.rds")
# ONS76-CBO unclustered dataset
o76only.o76cbo <- readRDS("outputs50K/ONS76-CBO/ONS76OnlyCells.SubsetONS76CboSample.Annotated.Rescaled.SCT.NoRiboNoMito.CCdiffRegressed.rds")
```

```{r}
dim(o76mono)
dim(o76spher)
dim(o76only.o76cbo)
```

Get the cell IDs of the 'o76only.Annot' object

```{r}
# cell names look fine
head(WhichCells(o76mono))
```

```{r}
# cell names look fine
head(WhichCells(o76spher))
```

```{r}
# cell IDs of o76only.o76cbo have a prefix, which must be removed!
head(WhichCells(o76only.o76cbo))
```

```{r}
# store the above cell IDs as a vector
o76only.cellID <- WhichCells(o76only.o76cbo)
```

```{r}
# remove the prefixes from the vector cell names and save as a new object of cell IDs
o76only.cellID.corrected <- gsub('o76cbo.data-', '', o76only.cellID)
head(o76only.cellID.corrected) # the prefixes have been removed
```

```{r}
# rename the cell IDs with the corrected cell names (.ccn = corrected cell names)
# the object o76only.o76cbo.ccn is the one to use going forwards
o76only.o76cbo.ccn <- RenameCells(o76only.o76cbo, new.names = o76only.cellID.corrected)
head(WhichCells(o76only.o76cbo.ccn))
```


****Perform the integration using Pearson residuals of the prepared datasets****
as per this Seurat vignette https://satijalab.org/seurat/articles/sctransform_v2_vignette.html
```{r}
o76.list <- list(o76mono, o76spher, o76only.o76cbo.ccn)
features <- SelectIntegrationFeatures(object.list = o76.list, nfeatures = 3000)
o76.list <- PrepSCTIntegration(object.list = o76.list, anchor.features = features)
```

```{r}
o76.anchors <- FindIntegrationAnchors(object.list = o76.list, normalization.method = "SCT",
    anchor.features = features)
```

```{r}
o76.combined.sct <- IntegrateData(anchorset = o76.anchors, normalization.method = "SCT")
```

```{r}
o76.3samples.combined.sct <- RunPCA(o76.combined.sct, verbose = FALSE) %>% 
  RunUMAP(reduction = "pca", dims = 1:30) %>% 
  FindNeighbors(reduction = "pca", dims = 1:30) %>% 
  FindClusters(resolution = 0.3)
```

```{r}
table(o76.3samples.combined.sct$orig.ident)
```

```{r}
# change the orig.ident notation for future plots
o76.3samples.combined.sct@meta.data[o76.3samples.combined.sct@meta.data == "ons76mono"] <- "ONS76_monolayer"
o76.3samples.combined.sct@meta.data[o76.3samples.combined.sct@meta.data == "ons76spher"] <- "ONS76_spheroid"
o76.3samples.combined.sct@meta.data[o76.3samples.combined.sct@meta.data == "ons76cbo"] <- "ONS76_coculture"
```

```{r}
# ONS76-2D = 474 cells; ONS76-CBO = 361; ONS76-spher = 1164 cells
table(o76.3samples.combined.sct$orig.ident)
```

```
{r}
# save the integrated object
saveRDS(o76.3samples.combined.sct,
        file = "./outputs50K/INTEGRATE/ons76onlyCocult.ONS76spher.ONS76mono.integrated.SCT.rds")
```

```{r}
o76.3samples.combined.sct <- readRDS("outputs50K/INTEGRATE/ons76onlyCocult.ONS76spher.ONS76mono.integrated.SCT.rds")
```

------------------------------------------------------------------------------------------------------
***Find differentially expressed genes in ONS76-spheroid vs ONS76-monolayer and produce a Volcano Plot***

```{r}
Idents(o76.3samples.combined.sct) <- "orig.ident"
```

```{r}
# from Seurat vignette https://satijalab.org/seurat/articles/sctransform_v2_vignette.html
o76.3samples.combined.sct <- PrepSCTFindMarkers(o76.3samples.combined.sct)

o76.3samples.combined.sct.subset <- 
  subset(o76.3samples.combined.sct, idents = c("ONS76_spheroid", "ONS76_monolayer"))

o76spherVSmono.allMarkers <- FindMarkers(o76.3samples.combined.sct.subset,
                                     assay = "SCT",
                                     ident.1 = "ONS76_spheroid", ident.2 = "ONS76_monolayer",
                                    verbose = FALSE,
                                    recorrect_umi = FALSE,
                                    logfc.threshold = 0.25 )
```

```
{r}
saveRDS(o76.3samples.combined.sct,
        file = "./outputs50K/INTEGRATE/ONS76onlyCocult.ONS76spher.ONS76mono.integrated.PrepSCTFindMarkers.rds")
```

```{r}
o76.3samples.combined.sct.prepSct <- 
  readRDS("outputs50K/INTEGRATE/ONS76onlyCocult.ONS76spher.ONS76mono.integrated.PrepSCTFindMarkers.rds")
```

```{r}
nrow(o76spherVSmono.allMarkers)
```

```{r}
o76SpherV2d.allMarkers.gene <- o76spherVSmono.allMarkers %>% 
  rownames_to_column(var = "gene")
```

```{r}
# save the PrepSCTmarkers object above
write.csv(o76SpherV2d.allMarkers.gene,
        file = "./outputs50K/INTEGRATE/DEgenesAll.ONS76SpherVSMono.Integrated.ONS76mono.ONS76Spher.ONS76Cocolture.csv",
        quote = FALSE)
```

```{r}
# load the differential expressed gene list
o76SpherV2d.allMarkers.gene <- 
  read.csv("outputs50K/INTEGRATE/DEgenesAll.ONS76SpherVSMono.Integrated.ONS76mono.ONS76Spher.ONS76Cocolture.csv")
```

```{r}
o76SpherV2d.allMarkers.gene %>% 
  dplyr::arrange(desc(avg_log2FC)) %>% 
  head(20)
```

```{r VolcanoPlotONS76SpheroidVSmonoDEGsIntegratedObject, fig.height=10, fig.width=15}
genes.to.label.o76SpherVsMono <- c("MGP", "APOE", "CHI3L1", "FABP4", "STC1", "IGFBP5", "KRT16", "IGFBP2",
                                    "PTN", "IFITM3", "POSTN")

EnhancedVolcano(o76SpherV2d.allMarkers.gene,
                lab = o76SpherV2d.allMarkers.gene$gene,
                x = "avg_log2FC",
                y = "p_val_adj",
                selectLab = genes.to.label.o76SpherVsMono,
                title = NULL,
                subtitle = NULL,
                pointSize = 5.0,
                labSize = 6.0,
                cutoffLineWidth = 1.0,
                axisLabSize = 30,
                legendLabSize = 25,
                legendIconSize = 10,
                legendPosition = "right",
                legendLabels = c("NS", "log2FC", "p-value", "p-value and Log2FC"),
                drawConnectors = TRUE,
                widthConnectors = 0.5,
                gridlines.major = FALSE,
                gridlines.minor = FALSE)

```


-------------------------------------------------------------------------------------------------------
***Find Genes differentially upregulated in ONS76-only cocultures vs ONS76-spher and produce a Volcano Plot***

```{r}
# load the PrepSCTFindMarkers object
o76.3samples.combined.sct <- 
  readRDS("outputs50K/INTEGRATE/ONS76onlyCocult.ONS76spher.ONS76mono.integrated.PrepSCTFindMarkers.rds")

o76.3samples.combined.sct.subset <- 
  subset(o76.3samples.combined.sct, idents = c("ONS76_coculture", "ONS76_spheroid"))

o76CocultVspher.allMarkers <- FindMarkers(o76.3samples.combined.sct.subset,
                                     assay = "SCT",
                                     ident.1 = "ONS76_coculture", ident.2 = "ONS76_spheroid",
                                    verbose = FALSE,
                                    recorrect_umi = FALSE,
                                    logfc.threshold = 0.25 )
```

```{r}
nrow(o76CocultVspher.allMarkers)
```

```{r}
o76CocultVspher.allMarkers.gene <- o76CocultVspher.allMarkers %>% 
  rownames_to_column(var = "gene")
```

```{r}
# save the DEGs which are both UP and DOWN regulated
write.csv(o76CocultVspher.allMarkers.gene, 
          file = "./outputs50K/INTEGRATE/DEgenesAll.ONS76CocultVSspher.Integrated.ONS76mono.ONS76Spher.ONS76Cocolture.csv",        quote = FALSE)
```

```{r}
# load the markers csv file
o76CocultVspher.allMarkers.gene <- 
  read.csv("outputs50K/INTEGRATE/DEgenesAll.ONS76CocultVSspher.Integrated.ONS76mono.ONS76Spher.ONS76Cocolture.csv")
```

```{r}
o76CocultVspher.allMarkers.gene %>% 
  dplyr::arrange(desc(avg_log2FC)) %>% 
  head(30)
```

```{r}
o76CocultVspher.allMarkers.gene.sorted <- o76CocultVspher.allMarkers.gene %>% 
  dplyr::arrange(desc(avg_log2FC))
```

```{r VolcanoPlotDAOYcocultVSspheroidDEGsIntegratedObject, fig.height=10,fig.width=15}
genes.to.label.o76CocultVsSpher <- 
  c("GKAP1", "NR2F1", "NNAT", "NEUROD1", "DCX", "DCC", "EYA2", "TRHDE", "THSD7B", "POU3F2", "HES6")

EnhancedVolcano(o76CocultVspher.allMarkers.gene,
                lab = o76CocultVspher.allMarkers.gene$gene,
                x = "avg_log2FC",
                y = "p_val_adj",
                selectLab = genes.to.label.o76CocultVsSpher,
                title = NULL,
                subtitle = NULL,
                pointSize = 5.0,
                labSize = 6.0,
                cutoffLineWidth = 1.0,
                axisLabSize = 30,
                legendLabSize = 25,
                legendIconSize = 10,
                legendPosition = "right",
                legendLabels = c("NS", "log2FC", "p-value", "p-value and Log2FC"),
                drawConnectors = TRUE,
                widthConnectors = 0.5,
                gridlines.major = FALSE,
                gridlines.minor = FALSE)

```


--------------------------------------------------------------------------------------------------------
***UMAP Plot of ONS76-spheroid, ONS76-monolayer and ONS76-only cells from ONS76-CBO sample after integration***

```{r}
# load the above object
o76.3samples.combined.sct <- 
   readRDS("outputs50K/INTEGRATE/ons76onlyCocult.ONS76spher.ONS76mono.integrated.SCT.rds")
```


```{r}
table(o76.3samples.combined.sct@meta.data$orig.ident)
```

Nice overlap of ONS76 cells grown in different conditions
```{r DimPlotIntegratedONS76OnlyCocultVsONS76SpherVsONS76mono, fig.height=6, fig.width=10}
DimPlot(o76.3samples.combined.sct, reduction = "umap", group.by = "orig.ident") +
  labs(title = "")
```

The clustering of the different samples shows little/no separation between cells originating from different samples, which is fine, and what is expected after integration

```{r}
Idents(o76.3samples.combined.sct) <- "orig.ident"
```

```{r}
# to plot the top 30 genes based on average log2FC
top30 <- o76CocultVspher.allMarkers.gene.sorted %>% top_n(n = 30, wt = avg_log2FC) # wt = -p_val_adj is an alternative
```

```{r}
# list includes ERBB4 near the top
top30
```

```{r}
# set DefaultAssay before running DoHeatmap: use RNA assay for integrated data
DefaultAssay(o76.3samples.combined.sct) <- "RNA"

# scale the data after setting the Default assay
o76.3samples.combined.sct.scaled <- ScaleData(o76.3samples.combined.sct, verbose = FALSE)
```

```{r HeatmapTop30genesONS76monoSpherDyOnlyCocultSamplesIntegratedRNAassay, fig.height=10, fig.width=12}
# Heatmap now uses all cells, no need to downsample
DoHeatmap(o76.3samples.combined.sct.scaled, features = top30$gene, size = 10, assay = "RNA", group.by = "ident") + 
  guides(color = "none") +
  theme(text = element_text(size = 20), legend.title = element_text(size=20), legend.text=element_text(size=20))
```

```{r VlnPlotSOX2NetworkONS76monoVs3dVsONS76CocultAllCells, fig.height=9, fig.width=12}
# check the RNA slot is used when plotting integrated data!!! In this case I made the default assay = RNA

VlnPlot(o76.3samples.combined.sct, 
        features = c("SOX2", "POU3F2","FABP7", "OTX2", "ZIC2", "GLI2"),
       slot = 'data',
       assay = 'RNA')
```

```{r VlnPlotSOX2NetworkERBB4ONS76monoVs3dVsONS76CocultAllCells, fig.height=9, fig.width=12}
# check the RNA slot is used when plotting integrated data!!! In this case I made the default assay = RNA

VlnPlot(o76.3samples.combined.sct, 
        features = c("SOX2", "ERBB4", "POU3F2","FABP7"),
       slot = 'data',
       assay = 'RNA')
```


--------------------------------------------------------------------------------------------------------
***Merge the ONS76-2D sample, the ONS76-SPHER, ONS76-CBO samples and CBO control to create UMAP plot***
 - to see how similar/different the samples are
```{r}
# load datasets
# ONS76-2D dataset
o76.2d <- readRDS("outputs50K/ONS76_2D/filt.RiboMitoCellsGenes.seurat.ons76monolayer.rds")
# ONS76-SPHER dataset
o76.3d <- readRDS("outputs50K/ONS76_SPHER/filt.RiboMitoCellsGenes.seurat.ons76spheroid.rds")
# ONS-CBO and CBO datasets
o76.cbo <- readRDS("outputs50K/ONS76-CBO/ons76cbo.seurat.filtCellsGenesNoRiboNoMito.rds")
cbo <- readRDS("outputs50K/CBO/filt.RiboMitoCellsGenes.seurat.cbo.rds")
```

```{r}
o76.4samples <- merge(o76.2d, 
                  y = c(o76.3d, o76.cbo, cbo), 
                  add.cell.ids = c("o762d", "o763d", "o76cbo", "cbo"), 
                  project = "dy4samples.merge")
o76.4samples
```

```{r}
unique(sapply(X = strsplit(colnames(o76.4samples), split = "_"), FUN = "[", 1))
```

```{r}
table(o76.4samples$orig.ident)
```

```{r}
# Create metadata dataframe
metadata <- o76.4samples@meta.data
# Add cell IDs to metadata
metadata$cells <- rownames(metadata)
# Create sample column
metadata$sample <- NA
metadata$sample[which(str_detect(metadata$cells, "^o762d_"))] <- "monolayer"
metadata$sample[which(str_detect(metadata$cells, "^o763d_"))] <- "spheroid"
metadata$sample[which(str_detect(metadata$cells, "^o76cbo_"))] <- "coculture"
metadata$sample[which(str_detect(metadata$cells, "^cbo_"))] <- "organoid"
```

```{r}
# assign metadata object back to the original seurat object
o76.4samples@meta.data <- metadata
```

```{r}
# create a dataframe of metadata as a means to generate a barplot of cell numbers per sample
# in the merged object
o76.4samples.df <- metadata 
o76.4samples.df$sample <- factor(o76.4samples.df$sample, 
                               levels = c("monolayer", "spheroid", "coculture", "organoid"))
```

```{r}
saveRDS(o76.4samples.df,
        file = "./outputs50K/INTEGRATE/ONS76fourSamplesMerged.CellNumbers.mono.spher.cocult.organoid.rds")
```


```{r BarChartONS76CellCounts2d3dONS76CboAndCbo4conditions, fig.height=7, fig.width=5}

o76.4samples.df <- readRDS("outputs50K/INTEGRATE/ONS76fourSamplesMerged.CellNumbers.mono.spher.cocult.organoid.rds")

ggplot(o76.4samples.df, aes(x=sample, fill=sample)) + 
  	geom_bar(fill = "grey") +
  	theme_classic() +
   theme(axis.title = element_blank(), axis.title.y = element_text(size = 18),
         axis.text.x = element_text(size = 14, angle = 45, hjust = 1), 
         axis.text.y = element_text(size = 14)) +
   NoLegend()
```

```{r}
o76.4samples <- NormalizeData(o76.4samples)
o76.4samples <- FindVariableFeatures(o76.4samples)
o76.4samples <- ScaleData(o76.4samples)
o76.4samples <- RunPCA(o76.4samples, features = VariableFeatures(object = o76.4samples))
o76.4samples <- RunUMAP(o76.4samples, dims = 1:5, reduction = "pca")
```

```{r}
saveRDS(o76.4samples, file = "./outputs50K/INTEGRATE/Ons76.4samplesMerged.2d.Spher.Cocult.CBO.pcaUmap.rds")
```

```{r}
o76.4samples <- readRDS("outputs50K/INTEGRATE/Ons76.4samplesMerged.2d.Spher.Cocult.CBO.pcaUmap.rds")
```


This result makes sense - separation of the monolayer and spheroid samples but strong overlap of ONS76-CBO and CBO (organoid) samples
```{r DimPlotMergedONS76CboSpher2dCboCNTRL4samples, fig.height=6, fig.width=10}
DimPlot(o76.4samples, reduction = "umap", group.by = "sample")
```



------------------------------------------------------------------------------------------------------------
***Merge of: 1. ONS76-2D, 2. ONS76-SPHEROID, 3. ONS76-only extracted from coculture cluster 3, 4. ONS only cluster 8 5. DAOY-2D (rep), 8. DAOY-spheroid cells, 9. DAOY-only extracted from coculture***
As the SCT assay has been used for the DAOY only cells in coculture and ONS76 only cells in co-culture, then get the cell IDs of the respective samples and use those cell IDs to subset the daoy-cbo and ons76-cbo samples that have NOT yet been through the SCT assay
```{r}
# load the DAOY samples
dy2d <- readRDS("outputs50K/DAOY_2D/filt.RiboMitoCellsGenes.seurat.DaoyMonolayer.rds")
dySpher <- readRDS("outputs50K/DAOY_SPHER/filt.RiboMitoCellsGenes.seurat.DAOYspher.rds")
dyOnly.dyCbo <- readRDS("outputs50K/DAOY-CBO/DAOYOnlyCells.SubsetDAOYCboSample.Annotated.Rescaled.SCT.NoRiboNoMito.CCdiffRegressed.rds")
dyCbo <- readRDS("outputs50K/DAOY-CBO/daoyCbo.seurat.filtCellsGenesNoRiboNoMito.rds")
```

```{r}
# load the ONS76 samples
# ONS76-2D dataset
o76.2d <- readRDS("outputs50K/ONS76_2D/filt.RiboMitoCellsGenes.seurat.ons76monolayer.rds")
# ONS76-SPHER dataset
o76.3d <- readRDS("outputs50K/ONS76_SPHER/filt.RiboMitoCellsGenes.seurat.ons76spheroid.rds")
# ONS-CBO and CBO datasets
o76only.o76cbo <- readRDS("outputs50K/ONS76-CBO/ONS76OnlyCells.SubsetONS76CboSample.Annotated.Rescaled.SCT.NoRiboNoMito.CCdiffRegressed.rds")
o76.cbo <- readRDS("outputs50K/ONS76-CBO/ons76cbo.seurat.filtCellsGenesNoRiboNoMito.rds")
```


****Remove prefixes from cell names of all the objects****
```{r}
head(WhichCells(dyCbo))
```

```{r}
head(WhichCells(o76.cbo))
```

REMOVE CELL NAME PREFIXES FROM "dyOnly.dyCbo"
```{r}
# get a vector of existing cell names that need to be changed
dyOnly.cells <- WhichCells(dyOnly.dyCbo)
```

```{r}
# .ccn = Corrected Cell Names
# change the cell names
dyOnly.cells.corrected <- gsub('dyCbo.data-', '', dyOnly.cells)
dyOnly.dyCbo.ccn <- RenameCells(dyOnly.dyCbo, new.names = dyOnly.cells.corrected)
```

```{r}
head(WhichCells(dyOnly.dyCbo.ccn))
```

REMOVE CELL NAME PREFIXES FROM "dyCbo"
```{r}
# get a vector of existing cell names that need to be changed
dyCbo.cells <- WhichCells(dyCbo)
```

```{r}
# .ccn = Corrected Cell Names
# change the cell names
dyCbo.cells.corrected <- gsub('dyCbo.data-', '', dyCbo.cells)
dyCbo.ccn <- RenameCells(dyCbo, new.names = dyCbo.cells.corrected)
```

```{r}
head(WhichCells(dyCbo.ccn))
```

REMOVE CELL NAME PREFIXES FROM "o76only.o76cbo"
```{r}
# cell IDs of o76only.o76cbo
head(WhichCells(o76only.o76cbo))
```

```{r}
# get a vector of existing cell names that need to be changed
o76only.cells <- WhichCells(o76only.o76cbo)
```

```{r}
# .ccn = Corrected Cell Names
# change the cell names
o76only.cells.corrected <- gsub('o76cbo.data-', '', o76only.cells)
o76only.o76cbo.ccn <- RenameCells(o76only.o76cbo, new.names = o76only.cells.corrected)
```

```{r}
head(WhichCells(o76only.o76cbo.ccn))
```

REMOVE CELL NAME PREFIXES FROM "o76.cbo"
```{r}
# get a vector of existing cell names that need to be changed
o76.cbo.cells <- WhichCells(o76.cbo)
```

```{r}
# .ccn = Corrected Cell Names
# change the cell names
o76.cbo.cells.corrected <- gsub('o76cbo.data-', '', o76.cbo.cells)
o76.cbo.ccn <- RenameCells(o76.cbo, new.names = o76.cbo.cells.corrected)
```

```{r}
head(WhichCells(o76.cbo.ccn))
```

All the cell names of all the objects are as they should be, i.e. without a prefix.


****Subset "dyCbo" and "o76.cbo" for the malignant clusters and save as new objects****

SUBSET THE 'dyCbo' OBJECT FOR MALIGNANT CLUSTERS
```{r}
# no prefixes in cell names
head(dyCbo.ccn@meta.data, 3)
```

```{r}
# subset the dyCbo.ccn object by the cell names of "dyOnly.dyCbo"
dyOnly.dyCbo.unclust <- subset(dyCbo.ccn, cells = WhichCells(dyOnly.dyCbo.ccn))
```

```{r}
# check that the DAOY cell IDs in the NON-clustered, non-SCT object are the same as the already clustered,
# dyOnly.dyCbo object which has been through the SCT assay. They are!
cellID.dyOnly.dyCbo.unclust <-  WhichCells(dyOnly.dyCbo.unclust)
cellID.dyOnly.dyCbo.ccn <- WhichCells(dyOnly.dyCbo.ccn)
identical(cellID.dyOnly.dyCbo.unclust, cellID.dyOnly.dyCbo.ccn)
```

SUBSET THE 'o76.cbo' OBJECT FOR MALIGNANT CLUSTERS
```{r}
# no prefixes in cell names
head(o76.cbo.ccn@meta.data, 3)
```

```{r}
# subset the o76.cbo.ccn object by the cell names of "o76only.o76cbo"
o76only.o76cbo.unclust <- subset(o76.cbo.ccn, cells = WhichCells(o76only.o76cbo.ccn))
```

```{r}
# check that the ONS76 cell IDs in the NON-clustered, non-SCT object are the same as the already clustered,
# o76only.o76cbo.ccn object which has been through the SCT assay. They are!
cellID.o76only.o76cbo.unclust <- WhichCells(o76only.o76cbo.unclust)
cellID.o76only.o76cbo.ccn <- WhichCells(o76only.o76cbo.ccn)
identical(cellID.o76only.o76cbo.unclust, cellID.o76only.o76cbo.ccn)
```

```{r}
head(o76only.o76cbo.unclust@meta.data, 3)
```

Get a new ONS76-only coculture seurat object for just cluster 3 and cluster 8
```{r}
# subset o76only.o76cbo.ccn for just the cell IDs of cluster 3
Idents(o76only.o76cbo.ccn) <- "seurat_clusters"

o76.cl3 <- subset(o76only.o76cbo.ccn, idents = c("3"))
o76.cl3.cellID <- WhichCells(o76.cl3)

# subset cellID.o76only.o76cbo.unclust for just the cell IDs of cluster 8
o76.cl8 <- subset(o76only.o76cbo.ccn, idents = c("8"))
o76.cl8.cellID <- WhichCells(o76.cl8)
```

```{r}
o76only.cl3 <- subset(o76only.o76cbo.unclust, cells = o76.cl3.cellID)
o76only.cl8 <- subset(o76only.o76cbo.unclust, cells = o76.cl8.cellID)
```


Therefore, we now have ONS76-mono, ONS76_spheroid, ONS76-cluster3, ONS76-cluster8, DAOY-mono, DAOY-spher, DAOY-only coculture. 7 samples total. None of these samples has been through SCT Assay.
```{r}
# create the merged object of ONS76 cells and DAOY cells
dy.o76.cells <- merge(o76.2d, 
                  y = c(o76.3d, o76only.cl3, o76only.cl8,
                        dy2d, dySpher, dyOnly.dyCbo.unclust), 
                  add.cell.ids = c("o76mono", "o76spher", "o76onlyCl3", "o76onlyCl8", "dy2d", "dySpher", "dyCocult"), 
                  project = "dy.ons76.merge")
```

```{r}
# Create metadata dataframe
metadata <- dy.o76.cells@meta.data
# Add cell IDs to metadata
metadata$cells <- rownames(metadata)
# Create sample column
metadata$sample <- NA
metadata$sample[which(str_detect(metadata$cells, "^o76mono_"))] <- "ONS76_monolayer"
metadata$sample[which(str_detect(metadata$cells, "^o76spher_"))] <- "ONS76_spheroid"
metadata$sample[which(str_detect(metadata$cells, "^o76onlyCl3_"))] <- "ONS76_cluster_3"
metadata$sample[which(str_detect(metadata$cells, "^o76onlyCl8_"))] <- "ONS76_cluster_8"
metadata$sample[which(str_detect(metadata$cells, "^dy2d_"))] <- "DAOY_monolayer"
metadata$sample[which(str_detect(metadata$cells, "^dySpher_"))] <- "DAOY_spheroid"
metadata$sample[which(str_detect(metadata$cells, "^dyCocult_"))] <- "DAOY_coculture"
head(metadata)
```

```{r}
dy.o76.cells@meta.data <- metadata
```

```{r}
dy.o76.cells <- ScaleData(dy.o76.cells)
```

```{r}
# change Idents from the default (which is cell IDs) to the sample
Idents(dy.o76.cells) <- "sample"

# re-order the sample levels
my.levels <- 
  c("ONS76_monolayer", "ONS76_spheroid", "ONS76_cluster_3", "ONS76_cluster_8", "DAOY_monolayer", "DAOY_spheroid", "DAOY_coculture")
levels(dy.o76.cells) <- my.levels
levels(dy.o76.cells)
```

```{r}
table(dy.o76.cells$sample)
```

```{r}
# this object was re-scaled after merging and only then was it saved
saveRDS(dy.o76.cells, 
file = "./outputs50K/INTEGRATE/daoy.ons76.Merged.7samples.o76Mono.o76Spher.o76clus3.o76clus8.dyMono.dySpher.dyOnlyCocult.rds")
```

```{r}
# load the merged object above
dy.o76.cells <- 
  readRDS("outputs50K/INTEGRATE/daoy.ons76.Merged.7samples.o76Mono.o76Spher.o76clus3.o76clus8.dyMono.dySpher.dyOnlyCocult.rds")
```

```{r VlnPlotSox2Network7samplesMergedONS762d3dAndOns76onlyCocultClustersDAOY2d3dCocult, fig.height=9, fig.width=14}
Idents(dy.o76.cells) <- "sample"
VlnPlot(dy.o76.cells,
        features = c("SOX2", "POU3F2", "FABP7", "OTX2", "ZIC2", "GLI2"),
        slot = "data",
        assay = "RNA")
```

```{r VlnPlotERBB4Nes7samplesMergedONS762d3dAndOns76onlyCocultClustersDAOY2d3dCocult, fig.height=9, fig.width=14}
VlnPlot(dy.o76.cells,
        features = c("ERBB4", "NRG3", "NES", "NEUROD1"),
        slot = "data",
        assay = "RNA")
```

****Merged object of above samples WITHOUT DAOY-only cells in co-culture****

```{r}
# create the merged object of ONS76 cells and DAOY cells
daoy.o76.cells.noDyCocult <- merge(o76.2d, 
                  y = c(o76.3d, o76only.cl3, o76only.cl8, dy2d, dySpher), 
                  add.cell.ids = c("o76mono", "o76spher", "o76cl3", "o76cl8", "dy2d", "dySpher"), 
                  project = "dy.ons.6samples.merge")
```

```{r}
# Create metadata dataframe
metadata <- daoy.o76.cells.noDyCocult@meta.data
# Add cell IDs to metadata
metadata$cells <- rownames(metadata)
# Create sample column
metadata$sample <- NA
metadata$sample[which(str_detect(metadata$cells, "^o76mono_"))] <- "ONS76_monolayer"
metadata$sample[which(str_detect(metadata$cells, "^o76spher_"))] <- "ONS76_spheroid"
metadata$sample[which(str_detect(metadata$cells, "^o76cl3_"))] <- "ONS76_cluster_3"
metadata$sample[which(str_detect(metadata$cells, "^o76cl8_"))] <- "ONS76_cluster_8"
metadata$sample[which(str_detect(metadata$cells, "^dy2d_"))] <- "DAOY_monolayer"
metadata$sample[which(str_detect(metadata$cells, "^dySpher_"))] <- "DAOY_spheroid"

head(metadata)
```

```{r}
daoy.o76.cells.noDyCocult@meta.data <- metadata
```

```{r}
daoy.o76.cells.noDyCocult <- ScaleData(daoy.o76.cells.noDyCocult)
```

```{r}
# change Idents from the default (which is cell IDs) to the sample
Idents(daoy.o76.cells.noDyCocult) <- "sample"

# re-order the sample levels
my.levels <- c("ONS76_monolayer", "ONS76_spheroid", "ONS76_cluster_3", "ONS76_cluster_8", "DAOY_monolayer", 
               "DAOY_spheroid")
levels(daoy.o76.cells.noDyCocult) <- my.levels
levels(daoy.o76.cells.noDyCocult)
```

```{r}
# change Idents from the default (which is cell IDs) to the sample
Idents(daoy.o76.cells.noDyCocult) <- "sample"
levels(daoy.o76.cells.noDyCocult)
```

```{r}
table(daoy.o76.cells.noDyCocult$sample)
# DAOY_mono = 1935 cells, DAOY_spher = 660 cells, ONS76_cluster_12 = 60 cells, ONS76_cluster_5 = 213 cells, ONS76_cluster_9 = 119 cells, ONS76_mono = 509 cells,  ONS_spher = 1171 cells
```

```{r}
# this object was re-scaled after merging and only then was it saved
saveRDS(daoy.o76.cells.noDyCocult, 
file = "./outputs50K/INTEGRATE/daoy.ons76.Merged.6samples.o76Mono.o76Spher.o76clus3.o76clus8.dyMono.dySpher.rds")
```

```{r}
# load the merged object above
daoy.o76.cells.noDyCocult <- 
  readRDS("outputs50K/INTEGRATE/daoy.ons76.Merged.6samples.o76Mono.o76Spher.o76clus3.o76clus8.dyMono.dySpher.rds")
```

```{r VlnPlotSox2Network8samplesMergedONS762d3dAndOns76onlyCocultClustersDAOY2d3d, fig.height=9, fig.width=12}
Idents(daoy.o76.cells.noDyCocult) <- "sample"

VlnPlot(daoy.o76.cells.noDyCocult,
        features = c("SOX2", "POU3F2", "FABP7", "OTX2", "ZIC2", "GLI2"),
        slot = "data",
        assay = "RNA")
```


***Find the proportions of cells in different phases of the cell cycle per ONS76 sample***
```{r}
# load the saved object, "dy.3samples.combined.sct" first, which has cell cycle phase info in metadata

# transfer meta.data to a new object called metadata.dy
metadata.o76 <- o76.3samples.combined.sct@meta.data %>% 
  rownames_to_column(var = "cellID") # this step needed as when 'select' is applied later on, the rownames
                                    # (cell names) are still retained
```

```{r}
# subset the metadata dataframe to keep just 'orig.ident' and 'Phase' columns (cc = cell cycle phase)
metadata.cc.o76 <- metadata.o76 %>% 
  dplyr::select(orig.ident, Phase)
# for each orig.ident get a count for each orig.ident and for each Phase
summ.stats.cc.1 <- metadata.cc.o76 %>% 
  dplyr::group_by(orig.ident, Phase) %>% 
  dplyr::summarise(count= n())

summ.stats.cc.1
```

```{r}
# convert the counts to a proportion where G1 count is divided by the sum of G1 + G2M + S counts
summ.stats.cc.2 <- summ.stats.cc.1 %>% 
  dplyr::group_by(orig.ident) %>% 
  dplyr::mutate(props = count / sum(count))

summ.stats.cc.2
```

```{r}
# re-order the levels for plotting in ggplot
summ.stats.cc.2$orig.ident <- factor(summ.stats.cc.2$orig.ident, levels = c("ONS76_monolayer", "ONS76_spheroid", "ONS76_coculture"))
```

```{r}
levels(summ.stats.cc.2$orig.ident)
```

```{r BarchartCellCyclePhaseProportionsON76MonoSpherCoculture, fig.height=4, fig.width=3}
# create a stacked barchart of the result
ggplot(summ.stats.cc.2, aes(x = orig.ident, y = props,  fill = Phase, label = format(round(props, digits = 2), nsmall = 2))) +
  geom_bar(position = "stack", stat = "identity") +
  geom_text(size = 3, position = position_stack(vjust = 0.5)) +
  theme_classic() +
  theme(axis.text.x = element_text(size = 14, angle = 45, hjust = 1)) +
  labs(x = "", y = "Proportion")
```

WHAT IS THE IDENTITY OF CELLS IN G1? GROUP CELLS BY 'PHASE' AND RUN DOHEATMAP

```
{r}
save.image("./RDataFiles/INTEGRATE_ONS76-CBO_ONS76-2D_ONS76-SPHER_CBO_seurat_50K.RData")
```


```{r}
sessionInfo()
```



Additional code not run but might be useful in future, including possible markers of interest to plot
#--------------------------------------------------------------------------------------------------
-------------------------------------------------------------------------------------------------------
***Explore geneset enrichment of ONS76-2D and ONS76-spher using presto and gProfiler (web app)***
fgsea did not work with this dataset (multifgsea command crashed, not sure why, but gProfiler worked!)
from: https://nbisweden.github.io/workshop-scRNAseq/labs/compiled/seurat/seurat_05_dge.html#Gene_Set_Enrichment_Analysis_(GSEA) and https://crazyhottommy.github.io/scRNA-seq-workshop-Fall-2019/scRNAseq_workshop_3.html
Merge the following: 
1) ONS76-2D single cluster 
2) ONS76-spher cluster 0 
3) ONS76-spher cluster 1 
4) ONS76-spher cluster 2
The files used are:
"phase.ons76spher.SCT.clustered.res0.4.rds" and "phase.filtRiboMito.SCT.regressedCCdiff.ons762d.rds"
Find the cell IDs of the cluster 0,1,2,3 cells in "phase.ons76spher.SCT.clustered.res0.4.rds" and extract those cells
```
{r}
phase.ons76spher.sct.clust.res0.4 <- 
readRDS("outputs50K/ONS76_SPHER/phase.ons76spher.SCT.clustered.res0.4.rds")
```

```
{r}
# make Idents the 'seurat_clusters
Idents(phase.ons76spher.sct.clust.res0.4) <- "seurat_clusters"
```

```
{r}
# extract the cell clusters
cl0cellID.ons76spher <- WhichCells(phase.ons76spher.sct.clust.res0.4, idents = "0")
cl1cellID.ons76spher <- WhichCells(phase.ons76spher.sct.clust.res0.4, idents = "1")
cl2cellID.ons76spher <- WhichCells(phase.ons76spher.sct.clust.res0.4, idents = "2")

length(cl0cellID.ons76spher)
length(cl1cellID.ons76spher)
length(cl2cellID.ons76spher)
```

For ONS76-spher: use the vector of cell IDs to subset the object "phase.ons76spher.sct.clust.res0.4" and pull out clusters 0 - 2 as separate clusters
```
{r}
# get ONS76 cells in cluster 0 of ONS76-spher using cell IDs
clus0.ons76spher <- subset(phase.ons76spher.sct.clust.res0.4, cells = cl0cellID.ons76spher)
clus1.ons76spher <- subset(phase.ons76spher.sct.clust.res0.4, cells = cl1cellID.ons76spher)
clus2.ons76spher <- subset(phase.ons76spher.sct.clust.res0.4, cells = cl2cellID.ons76spher)
```

```
{r}
# load the ONS76-2D sample (this is one big cluster of cells)
ons76mono.sct <- readRDS("outputs50K/ONS76_2D/phase.filtRiboMito.SCT.regressedCCdiff.ons762d.rds")
```

```
{r}
# merge the above datasets
ons76.mono.spher.merged <- merge(ons76mono.sct,
                                 y = c(clus0.ons76spher, clus1.ons76spher, clus2.ons76spher),
                                 add.cell.ids = c("o76mono", "clus0.o76spher", 
                                                  "clus1.o76spher", "clus2.o76spher"),
                                 project = "ons76.mono.spher.merge")
```

```
{r}
head(ons76.mono.spher.merged@meta.data)
```

```
{r}
# assign cells to "seurat_clusters"
metadata <- ons76.mono.spher.merged@meta.data
metadata$cells <- rownames(metadata)
metadata$seurat_clusters[which(str_detect(metadata$cells, "^o76mono_"))] <- "mono"
metadata$seurat_clusters[which(str_detect(metadata$cells, "^clus0.o76spher_"))] <- "0"
metadata$seurat_clusters[which(str_detect(metadata$cells, "^clus1.o76spher_"))] <- "1"
metadata$seurat_clusters[which(str_detect(metadata$cells, "^clus2.o76spher_"))] <- "2"
head(metadata)
```

```
{r}
ons76.mono.spher.merged@meta.data <- metadata
```

```
{r}
ons76.mono.spher.genes <- wilcoxauc(ons76.mono.spher.merged, "seurat_clusters")
```

```
{r}
head(ons76.mono.spher.genes)
```

```
{r}
# we have all the genes for each cluster
dplyr::count(ons76.mono.spher.genes, group)
```

```
{r}
# order the genes for input to gProfiler (web app!)
ons76.mono.UPgenes <- ons76.mono.spher.genes %>% 
  dplyr::filter(group == "mono" & logFC > 0.25) %>%
  arrange(desc(auc)) %>% 
  dplyr::select(feature, auc)

nrow(ons76.mono.spher.UPgenes) # I used 1385 genes in g:Profiler
```

```
{r}
# this will be used as input for UPregulated genes in g:Profiler. Transfer file via Filezilla to
# Excel on Mac
write.csv(ons76.mono.UPgenes, 
          "./outputs50K/INTEGRATE/ONS76.monoSpher.merged.monoUPgenes.PRESTO.gProfilerInput.csv", 
          quote = F)
```

```
{r}
# order the genes for input to gProfiler (web app!)
ons76.spher.clus0.UPgenes <- ons76.mono.spher.genes %>% 
  dplyr::filter(group == "0" & logFC > 0.25) %>%
  arrange(desc(auc)) %>% 
  dplyr::select(feature, auc)

nrow(ons76.spher.clus0.UPgenes) # I used 422 genes in g:Profiler
```

```
{r}
# this will be used as input for UPregulated genes in g:Profiler web app. Transfer file via Filezilla to
# Excel on Mac
write.csv(ons76.spher.clus0.UPgenes, 
          "./outputs50K/INTEGRATE/ONS76.monoSpher.merged.cluster0spherUPgenes.PRESTO.gProfilerInput.csv", 
          quote = F)
```

```
{r}
# order the genes for input to gProfiler (web app!)
ons76.spher.clus1.UPgenes <- ons76.mono.spher.genes %>% 
  dplyr::filter(group == "1" & logFC > 0.25) %>%
  arrange(desc(auc)) %>% 
  dplyr::select(feature, auc)

nrow(ons76.spher.clus1.UPgenes) # I used 321 genes in g:Profiler
```

```
{r}
# this will be used as input for UPregulated genes in g:Profiler web app. Transfer file via Filezilla to
# Excel on Mac
write.csv(ons76.spher.clus1.UPgenes, 
          "./outputs50K/INTEGRATE/ONS76.monoSpher.merged.cluster1spherUPgenes.PRESTO.gProfilerInput.csv", 
          quote = F)
```

```
{r}
# order the genes for input to gProfiler (web app!)
ons76.spher.clus2.UPgenes <- ons76.mono.spher.genes %>% 
  dplyr::filter(group == "2" & logFC > 0.25) %>%
  arrange(desc(auc)) %>% 
  dplyr::select(feature, auc)

nrow(ons76.spher.clus2.UPgenes) # I used 206 genes in g:Profiler
```

```
{r}
# this will be used as input for UPregulated genes in g:Profiler web app. Transfer file via Filezilla to
# Excel on Mac
write.csv(ons76.spher.clus2.UPgenes, 
          "./outputs50K/INTEGRATE/ONS76.monoSpher.merged.cluster2spherUPgenes.PRESTO.gProfilerInput.csv", 
          quote = F)
```

-------------------------------------------------------------------------------------------------------------------
***Integration of ONS76-2D, ONS76-SPHEROID and ONS76-only extracted from coculture, cluster 9 and clusters3+8***

```
{r}
Idents(phase.ons76cbo.sct.clust) <- "seurat_clusters"
cl9.ons76cboCells <- subset(phase.ons76cbo.sct.clust, subset = (seurat_clusters %in% c(9)))
```

Find the cell IDs of the cluster 9 cells in "phase.ons76cbo.sct.clust" and extract those cells
```
{r}
cl9cellID <- WhichCells(phase.ons76cbo.sct.clust, idents = "9")
length(cl9cellID)
```

For ONS76-only cocultures: use the vector of cell IDs to subset the object "filtRiboMitoCellsGenes.ons76cbo.rds" and pull out cluster 9, and also get clusters 3 and 8 as separate clusters
```
{r}
# get ONS76 cells in cluster 9 of ONS76-CBO using cell IDs
o76.cbo <- readRDS("outputs50K/ONS76-CBO/filtRiboMitoCellsGenes.ons76cbo.rds")
cl9.ons76Cbo <- subset(o76.cbo, cells = cl9cellID)

# get ONS76 cells in clusters 3 and 8 using subsetting based on cluster selection
Idents(phase.ons76cbo.sct.clust) <- "seurat_clusters"
cl3.8.ons76 <- subset(phase.ons76cbo.sct.clust, subset = (seurat_clusters %in% c(3, 8)))
dim(cl3.8.ons76)
```

```
{r}
cl3.8.ons76$orig.ident <- "ONS76_clusts_3_8_coculture"
```

```
{r}
head(cl3.8.ons76@meta.data)
```


```
{r}
ons76mono <- readRDS("outputs50K/ONS76_2D/filt.NoRiboNoMito.ons76.2d.rds")
ons76spher <- readRDS("outputs50K/ONS76_SPHER/filt.NoRiboNoMito.ons76spher.rds")
```

Downsample the ONS76-2D and ONS76-spheroid samples so that they are around 400 cells each
```
{r}
# get the cell IDs of all cells in DAOY-2D sample
o76.IDs.mono <- WhichCells(ons76mono)
length(o76.IDs.mono)
set.seed(162)
# pick a random sample of 400
o76.mono.small <- sample(o76.IDs.mono, size = 400, replace = FALSE)
```

```
{r}
o76mono.400cells <- subset(ons76mono, cells = o76.mono.small)
dim(o76mono.400cells)
```

Now subsample the ONS76-spheroid sample
```
{r}
# get the cell IDs of all cells in DAOY-spher sample
o76.IDs.spher <- WhichCells(ons76spher)
length(o76.IDs.spher)
set.seed(173)
# pick a random sample of 400
o76.spher.small <- sample(o76.IDs.spher, size = 400, replace = FALSE)
```

```
{r}
o76spher.400cells <- subset(ons76spher, cells = o76.spher.small)
dim(o76spher.400cells)
```

```
{r}
ons76.4samples.list2 <- list(o76mono.400cells, o76spher.400cells, cl9.ons76Cbo, cl3.8.ons76)
ons76.4samples.list2.sct <- suppressWarnings(lapply(X = ons76.4samples.list2, FUN = SCTransform))
features <- SelectIntegrationFeatures(object.list = ons76.4samples.list2.sct, nfeatures = 3000)
ons76.4samples.list2.sct <- PrepSCTIntegration(object.list = ons76.4samples.list2.sct, anchor.features = features)
```



```
{r}
ons76.4samples.combined.sct2 <- RunPCA(ons76.4samples.combined.sct2, verbose = FALSE)
ons76.4samples.combined.sct2 <- RunUMAP(ons76.4samples.combined.sct2, reduction = "pca", dims = 1:30)
ons76.4samples.combined.sct2 <- FindNeighbors(ons76.4samples.combined.sct2, 
                                           reduction = "pca", 
                                           dims = 1:30)
ons76.4samples.combined.sct2 <- FindClusters(ons76.4samples.combined.sct2, resolution = 0.2)
```

```
{r}
# change the orig.ident notation for future ggplots, seurat plots
ons76.4samples.combined.sct2@meta.data[ons76.4samples.combined.sct2@meta.data == "ONS76-2D"] <- "ONS76_monolayer"
ons76.4samples.combined.sct2@meta.data[ons76.4samples.combined.sct2@meta.data == "ons76spher"] <- "ONS76_spheroid"
ons76.4samples.combined.sct2@meta.data[ons76.4samples.combined.sct2@meta.data == "ONS76-CBO"] <- "ONS76_clust9_coculture"

```

```
{r}
saveRDS(ons76.4samples.combined.sct2,
        file = "outputs50K/INTEGRATE/ons76.clus9Cbo.clus3ANDclus8Cbo.Mono.Spher.4samples.DownsampledIntegrated.SCT.rds")
```

```
{r}
# load the above object
ons76.4samples.combined.sct2 <- readRDS("outputs50K/INTEGRATE/ons76.clus9Cbo.clus3ANDclus8Cbo.Mono.Spher.4samples.DownsampledIntegrated.SCT.rds")
```

```
{r}
table(ons76.4samples.combined.sct2$orig.ident)
```

```
{r DimplotONS763samplesSCTintegrationMonoVsSperVsCluster9fromONS76CboSample, fig.height=3}
DimPlot(ons76.4samples.combined.sct2, reduction = "umap", group.by = "orig.ident")
```

SOX2 is marginally increased in the coculture condition, but overall is more evenly expressed at high level in the different ONS76 cell samples compared to expression in DAOY cells. POU3F2 is markedly increased in co-cultured ONS76 cells.
```
{r VlnPlotSOX2networkErbb4ONS76CboClust9VsMonoVsSpher3samples, fig.height=10, fig.width=14}
Idents(ons76.4samples.combined.sct2) <- "orig.ident"
VlnPlot(ons76.4samples.combined.sct2, 
        features = c("SOX2", "POU3F2","FABP7", "TTYH1", "ERBB4", "NRG3"),
        slot = "data",
        assay = "RNA"
        )
```

```
{r VlnPlotDcxMeis1Hes6ONS76CboClust9VsMonoVsSpher3samples, fig.height=9, fig.width=14}
Idents(ons76.4samples.combined.sct2) <- "orig.ident"
VlnPlot(ons76.4samples.combined.sct2, 
        features = c("NNAT","MIR124-2HG", "DCX", "CTNNA2", "MEIS1", "HES6"),
        slot = "data",
        assay = "RNA"
        )
```

MAPK3, PROX1 can regulate SOX2 expression. However, could be SMAD2/3/4/5 maintain higher levels of SOX2 in ONS76 cells vs DAOY cells. In addition, the inhibitory SMADs, SMAD6/7 are expressed at lower level than in DAOY cells. The targets of SMAD signaling SERPINE1 and ID1 are expressed at higher level than in DAOY cells, although it should be noted the regulation of these targets by SMADs is context-dependent (https://doi.org/10.1038/onc.2012.191)
```
{r  VlnPlotHoxB2ShhSMADGenesONS76CboClust9VsMonoVsSpher3samples, fig.height=25, fig.width=12}

VlnPlot(ons76.3samples.combined.sct2, features = c("HOXB2","IRX3", "TWIST1",
                                        "PTCH1", "GLI1", "GLI2", "GLI3", "HHIP",
                                        "MYC", "MYCN", "ZIC1", "OTX2", "MAPK3","PROX1", "SMAD1", "SMAD2",
                                        "SMAD3", "SMAD4", "SMAD5", "SMAD6", "SMAD7", "SERPINE1", "ID1"))
```

```
{r}
# k.filter = NA and k.weight = 77 as if there are fewer than ~ 200 cells in a sample, the below functions
# do not run and throw an error.
ons76.4samples.sct.anchors2 <- FindIntegrationAnchors(object.list = ons76.4samples.list2.sct, 
                                            normalization.method = "SCT",
                                            anchor.features = features,
                                            k.filter = NA)
ons76.4samples.combined.sct2 <- IntegrateData(anchorset = ons76.4samples.sct.anchors2, normalization.method = "SCT",
                                              k.weight = 77)
```

Investigate Notch-delta signalling in all samples > of most interest is the expression of HES4, HES5 and HES6 in the ONS76 (cluster 9) or DAOY cells extracted from CBO coculture
```
{r Heatmap7samplesMergedDy2d3dcocultONS2d3dclust3AND8clust9Notchgenes, fig.height=4}
notch.genes <- c("SOX2", "HEY1", "HEY2", "HEYL", "DEC1",
                  "HES1", "HES4", "HES6",  "HES2",
              "HES5", "HES7","DLL1", "DLL3", "DLL4", "JAG1", "JAG2")
DoHeatmap(daoy.o76.cells,
          features = notch.genes,
          group.by = levels("sample"),
          slot = "scale.data",
          assay = "RNA") +
  guides(color = "none") +
  theme(axis.text = element_text(size = 12))
```


Investigate Neuregulin signalling in all samples
```
{r Heatmap7samplesMergedDy2d3dcocultONS2d3dclust3AND8clust9notchGenes, fig.height=4}
neureg.genes <- c("SOX2", "ERBB2", "ERBB3", "ERBB4", "NRG1", "NRG2", "NRG3", "NRG4")
DoHeatmap(daoy.o76.cells,
          features = neureg.genes,
          group.by = levels("sample"),
          slot = "scale.data",
          assay = "RNA") +
  theme(axis.text = element_text(size = 12))
```

```
{r}
sox.genes <- c("SOX2", "POU3F2", "FABP7")
DoHeatmap(daoy.o76.cells,
          features = sox.genes,
          group.by = levels("sample"),
          slot = "scale.data",
          assay = "RNA") +
  theme(axis.text = element_text(size = 12))
```

```
{r}
# THIS WAY OF SUBSETTING THE INTEGRATED OBJECT ALSO WORKS!
Idents(daoy.o76.cells) <- "sample"
dy.o76.small <- subset(daoy.o76.cells, 
                       subset = (sample %in% c("ONS76_monolayer", "ONS76_spheroid",
                                               "ONS76_cluster_9", "ONS76_clusters_3_8",
                                               "DAOY_monolayer", "DAOY_spheroid")))
```

```
ons76.spher.cbo.clust <- subset(ons76.all.combined.sct.clust, subset = (orig.ident == "ONS76-CBO" | orig.ident == "ons76spher"))
```

```
# THIS WAY OF SUBSETTING THE INTEGRATED OBJECT ALSO WORKS!
subset(ons76.all.combined.sct.clust, subset = (orig.ident %in% c("ONS76-CBO", "ons76spher")))
```

Getting Idents
```
table(Idents(ons76.spher.cbo.clust))
```

How to load CSV files
```
# in general, no need to load the csv files. Here one is loaded just to remind me what arguments
# to use
clus0.ons76.cocult.vs.spher.all <- read.csv(
  "outputs50K/INTEGRATE/clus0.ons76.cocult.vs.spher.allDEgenes.csv",
         header = TRUE,
         stringsAsFactors = FALSE)
```
How to write CSV files
```
# reminder of how to use write.csv() function
write.csv(clus1.ons76.cocult.vs.spher.pos, 
          file = "./outputs50K/INTEGRATE/clus1.ons76.cocult.vs.spher.posDEgenes.csv", 
          quote = F) 
```

How to subset a Seurat object
```
ons76.all.combined.sct.clust <- NormalizeData(object = ons76.all.combined.sct.clust, assay = "RNA")
DefaultAssay(ons76.all.combined.sct.clust) <- "RNA"
ons76.cbo.2d.clust <- subset(ons76.all.combined.sct.clust, subset = (orig.ident == "ONS76-CBO" | orig.ident == "ONS76-2D"))
```


------------------------------------------------------------------------------------------------
***Use upregulated genes in ONS76 spheroids vs 2D as query list for AddModuleScore() to identify cells that are ONS76 cells in the ONS76-CBO sample***
Unfortunately this approach did not work!
Get lists of upregulated genes for each of the 4 clusters in ONS76-SPHER vs ONS76-2D - restrict the list to the top 30 in each cluster. The idea is to make lists of UP-regulated genes in each cluster of ONS76-SPHER, and then try searching for cells in the co-culture condition (ONS76-CBO) that express those 'modules'. If found, these will be ONS76 cancer cells. Use dplyr select() to get just the genes. Doing this does not work, because for one module (clus0), virtually all cells in the ONS76-CBO sample express the module at high level, but for other modules much fewer cells express it.

-----------------------------------------------------------------------------------------------
***Integrated analysis of the ONS76-CBO sample, ONS76-SPHEROID and CBO samples - conventional normalization***
The idea is to see whether ONS76 cells in the co-culture sample cluster with other cancer cells in the ONS76-spheroid sample. CONVENTIONAL NORMALIZATION was used. I used RECIPROCAL PCA instead of CCA as is commonly used when integrating datasets that are biologically different. This worked and showed that SOME ONS76-CBO cells cluster with the ONS876-spheroid cells and other ONS76-CBO cells resembling rhombic lip/GCP progenitors cluster with a separate cluster of ONS76-spheroid cells that might be more differentiated. Let's pull out these ONS76-CBO cells that are in cluster 0 and cluster 7

----------------------------------------------------------------------------------------------------------
***Subclustering of conventional integrated seurat object (cluster 7)***
Able to do this, but did not prove helpful for the analysis
Cluster 7 in the conventional integration workflow (seurat object: ons76.integrated) is an interesting cluster. Try to subcluster this cluster, and then do differential expression. However, it would be good to know the sample origins of the subclusters of cluster 7. This information should be in meta.data (orig.ident).
```
# get the graph names for subclustering
names(ons76.integrated@graphs)
```
The subclustering works. res=0.5 or res=0.4 does not make a difference to number of subclusters.
```
ons76.integrated <- FindSubCluster(ons76.integrated, 
                            cluster = "7",
                            graph.name = "integrated_nn",
                            subcluster.name = "GCP",
                            resolution = 0.5,
                            algorithm = 1)          # '1' is the original Louvain algorithm
```

I ran this code to check the column names of meta.data after 'subcluster.name=GCP' was added to
```
head(ons76.integrated@meta.data, n = 20)
```

```
# filter the rows that have seurat_clusters == 7
metadata.clus7 <- ons76.integrated@meta.data %>% 
  filter(seurat_clusters == 7)

head(metadata.clus7)
```

Do a ggplot of orig.ident vs GCP category. We can see that all three subclusters 7_0 to 7_2 are represented in all conditions (CBO, ONS76-CBO and ons76spher). So I can dismiss the hypothesis that the subclusters are specific to one condition only. However, subcluster 7_2 accounts for around 50% of ONS76-SPHER sample, whereas this subcluster forms a smaller proportion of the other two conditions. Not possible to draw firm conclusion as to whether these differences are meaningful as the number of cells in GCP cluster for ONS76-SPHER is only 63.
```
ggplot(data = metadata.clus7, aes(x = orig.ident, fill = GCP)) +
         geom_bar()
```

Visualise the subclusters on a UMAP plot. Notice the 'group.by' argument is set to 'GCP' which is the subclustered cluster 7.
```
DimPlot(ons76.integrated, reduction = "umap", group.by = "GCP", label = TRUE)
```

Get violin plots of NEUROD1 clusters in the integrated seurat object. This shows that compared to the analysis of a single sample and its control (ONS76-CBO vs CBO) the integration has resulted in reduced complexity of the NEUROD1 expressing cell subtype. In the INTEGRATED workflow there are two NEUROD1 clusters (cluster 3 and 9) which have cells from both CBO and ONS76-CBO. So it will not be helpful to compare DEGs between cluster 3 and 9.
```
VlnPlot(ons76.integrated, 
        features = c("NEUROD1", "CNTN1", "CNTN2", "GRIA4", "RRM2", "ACTC1"))
```

***Subclustering of conventional integrated seurat object (cluster 3 and cluster 9)***
Let's try subclustering cluster 3 first - this is the main NEUROD1+ cluster. We'll see if there are cells which distinguish wild-type cerebellar neurons from the ONS76-CBO sample. This is the bigger of two NEUROD1+ clusters.
```
ons76.integrated <- FindSubCluster(ons76.integrated, 
                            cluster = "3",
                            graph.name = "integrated_nn",
                            subcluster.name = "neurod1_3",
                            resolution = 0.4,
                            algorithm = 1)          # '1' is the original Louvain algorithm
```

The subclusters are present in both conditions, ONS76-CBO and the CBO control (none in spheroid). There are more ONS76-CBO NeuroD1+ cells in cluster 3 than in cluster 3 of CBO sample.
```
# filter the rows that have seurat_clusters == 3
metadata.clus3 <- ons76.integrated@meta.data %>% 
  filter(seurat_clusters == 3)

ggplot(data = metadata.clus3, aes(x = orig.ident, fill = neurod1_3)) +
         geom_bar()
```

Same result for cluster 9 as for cluster 3. Three subclusters found and all three are present in both conditions! There are more ONS76-CBO NeuroD1+ cells than CBO NeuroD1+ cells in cluster 9. The integrated object used here might not be the best way to look at this cluster as the cells are aligned and differences between cells are reduced compared to when individual samples are analysed (e.g. ONS76-CBO compared to CBO control).
```
ons76.integrated <- FindSubCluster(ons76.integrated, 
                            cluster = "9",
                            graph.name = "integrated_nn",
                            subcluster.name = "neurod1_9",
                            resolution = 0.4,
                            algorithm = 1)          # '1' is the original Louvain algorithm

# filter the rows that have seurat_clusters == 9
metadata.clus9 <- ons76.integrated@meta.data %>%
  filter(seurat_clusters == 9)

ggplot(data = metadata.clus9, aes(x = orig.ident, fill = neurod1_9)) +
         geom_bar()

```

-------------------------------------------------------------------------------------------------------
***Integrate the NEUROD1+ clusters in ONS76-CBO and CBO samples after SCT normalisation***
This approach did not work.
Instead of above approach, extract all the individual NeuroD1+ cells from the CBO cluster, and from the ONS76-CBO cluster. CBO cluster has 1 NeuroD1+ cluster and the ONS76-CBO cluster has 3 NeuroD1+ clusters


-------------------------------------------------------------------------------------------------------
***Integrate (by RPCA) the NEUROD1+ clusters in ONS76-CBO and CBO samples after conventional normalization***
This too doesn't work
First run conventional normalization on CBO sample at res=0.5 (higher res gives 2 NeuroD1 clusters!). There is only 1 NeuroD1+ cluster!

---------------------------------------------------------------------------------------------------
This code is for illustration only to show the workflow
***Running SCTransform based integration***
``` SCtransform_CBO_ONS76-CBO
# prepare the SCTransformed seurat objects
# the seurat object has NO mitochondrial and NO ribosomal genes
# 'outputs50K" folder contains the correct RDS seurat object
# when running this code the warning' "Warning in theta.ml(y = y, mu = fit$fitted) : iteration limit reached" will appear regularly. See this Stack Exchange answer (https://bioinformatics.stackexchange.com/questions/16439/sctransform-warning-in-theta-mly-y-mu-fitfitted-iteration-limit-reach) for the meaning. This behaviour of the code is expected.

filt.noRiboMito.ons76.2d <- readRDS("outputs50K/ONS76_2D/filt.NoRiboNoMito.ons76.2d.rds")

filt.noRiboMito.ons76spher <- readRDS("outputs50K/ONS76_SPHER/filt.NoRiboNoMito.ons76spher.rds")

ons76.cells.cocult <- readRDS("outputs50K/ONS76-CBO/ons76.cells.only.rds")

ons76.all.list <- list(filt.noRiboMito.ons76.2d, filt.noRiboMito.ons76spher, ons76.cells.cocult)

ons76.all.list <- suppressWarnings(lapply(X = ons76.all.list, FUN = SCTransform))
```

```
features <- SelectIntegrationFeatures(object.list = ons76.all.list, nfeatures = 3000)

ons76.all.list <- PrepSCTIntegration(object.list = ons76.all.list, anchor.features = features)
```

```
ons76.all.anchors <- FindIntegrationAnchors(object.list = ons76.all.list, normalization.method = "SCT",
    anchor.features = features)
ons76.all.combined.sct <- IntegrateData(anchorset = ons76.all.anchors, normalization.method = "SCT")
```

```
# save the combined (integrated) seurat object, which includes: ONS76-2D, ONS76-SPHER, and ONS76 cells extracted
# from ONS76-CBO sample.
# note this integrated seurat object has NOT been through PCA or UMAP commands

saveRDS(ons76.all.combined.sct, file = "./outputs50K/INTEGRATE/ons76.all.combined.sct.rds")
```

```
# here we read in the ons76 cells from monolayer, spheroid, and ons76-CBO coculture
ons76.all.combined.sct <- readRDS("outputs50K/INTEGRATE/ons76.all.combined.sct.rds")
```

```
ons76.all.combined.sct <- RunPCA(ons76.all.combined.sct, verbose = FALSE)
ons76.all.combined.sct <- RunUMAP(ons76.all.combined.sct, reduction = "pca", dims = 1:30)
```

```
ons76.all.combined.sct <- FindNeighbors(ons76.all.combined.sct, 
                                           reduction = "pca", 
                                           dims = 1:30)
```

```clustree, fig.height=8
# Select a range of resolutions
resolution.range <- seq(from = 0, to = 1, by = 0.2)

# Find clusters using a range of resolutions, the clustering information is in the metadata slot
ons76.all.combined.sct.clusters <- FindClusters(object = ons76.all.combined.sct, 
                                             resolution = resolution.range,
                                             verbose = FALSE)

# apply Clustree: this suggests there are 3 or possibly 4 clusters (4th cluster is smallest)
clustree(ons76.all.combined.sct.clusters)
```

```r findClusters_res0.2_res0.4

ons76.all.clusters.res0.2 <- FindClusters(ons76.all.combined.sct, resolution = 0.2)

ons76.all.clusters.res0.4 <- FindClusters(ons76.all.combined.sct, resolution = 0.4)
```

```DimplotsRes0.2Integrated3samples, fig.height=12, fig.width=8
# With res=0.2, there are 3 clusters in ONS76-2D and ONS76-CBO, but 4 clusters in ons76spher. 
# The 4th cluster in ons76spher is small.
# THE INTEGRATION OF 3 CONDTIONS: ONS76-2D, ONS76-SPHER AND ONS76 CELLS IN COCULTURE HAS WORKED VERY WELL -
      # there is great overlap of the UMAP clusters from the three conditions, which is probably 
      # because this type of integration forces dissimilar cells to be more similar!
p1 <- DimPlot(ons76.all.clusters.res0.2, reduction = "umap", group.by = "orig.ident")
p2 <- DimPlot(ons76.all.clusters.res0.2, reduction = "umap", split.by = "orig.ident")
p3 <- DimPlot(ons76.all.clusters.res0.2, reduction = "umap", label = TRUE, repel = TRUE)

p1 / p2 / p3
```

-----------------------------------------------------------------------------------------------------
***Perform integration of ONS76-2D and ONS76-SPHER, then PCA/UMAP to compare the samples***
This workflow makes the cells too similar in terms of gene expression. The same cells grown under different conditions (spheroids or monolayer cells) end up being intermingled, which is not useful
```
